---
title: "Perturbations monk parakeets"
author: "Annemarie"
date: "23/05/2020"
output:
  pdf_document: default
  html_document: default
---

R code to obtain the dominance hierarchy of 3-day period 
  - Dominance rank 

Basics
-	Number of total aggressive events observed
-	Total hours observed

Figures
1.	Rank plot 
2.	Mass changes
SM2.  Average power score change vs power score change focal
SM3.	Mass changes on rank 
SM4.  sex on rank (regressions)


#Load packages
```{r, include=FALSE, echo=FALSE}
library(tidyverse)
library(reshape2)
library(stringr)
library(purrr)
library(domstruc) #install_github("danm0nster/domstruc")
library(ggbump)
library(lubridate)
library(ggthemes)
library(ggrepel)
library(ggpubr)
library(betareg)
library(glmmADMB)
library(lme4)
library(lmtest)

#citation("betareg")

```


# Import data

```{r raw data import, echo=FALSE}
## agonistic interaction data
behave_raw <- read.csv("./data/2021_MOPA_agonistic interactions_longperturb.csv") %>%
  dplyr::select(-X)  # whole field season
glimpse(behave_raw)


# bird list
birdIDs_capture<- read.csv("./data/2021_MOPA_IDs.csv") 
birdIDs <- birdIDs_capture %>%
  dplyr::select(mark_id)

# capture file
size<- read.csv("./data/morphometrics_focals_2021.csv") %>%
  dplyr::select(date, id, weight)

# bin dates
bin.dates <- read.csv("./data/2021_3daybins.csv")

```

```{r created data import}

## interaction data
# this is where duplicates are removed and aggression data is summarized by bin
dyad.aggXbin <- read.csv("./output/2021_aginteractions_socialperturb.csv") %>%
  dplyr::select(-X) 

## summary files of output 
#  long perturbation summary
summary <- read.csv("./output/long_perturbation_summary.csv")

# individual rank X bin
powerXbin <- read.csv("./output/MOPA_power score.csv")




```



# Ready data  

## Helper functions & data
```{r echo=FALSE}

#make matrix function (from dataframe, 1st col with row names)
matrix.please<-function(x) {
  m<-as.matrix(x[,-1])
  rownames(m)<-x[,1]
  m
}


```

## bird list
change for each perturbation as different birds are removed
```{r}
##list of all valid color combinations
# birdIDs$mark_id = all 20 birds
birdIDs_removal1 <- birdIDs %>% filter(mark_id!="BBB")
birdIDs_removal2 <- birdIDs %>% filter(mark_id!="GPG")
birdIDs_removal3 <- birdIDs %>% filter(mark_id!="OPP")

# change each time
bird.list <- sort(unique(birdIDs$mark_id)) 
length(bird.list)
bird.list

# list of all possible dyads
dyad.list <- expand.grid(bird.list, bird.list) #head(dyad.list)
names(dyad.list) <- c("actor", "subject")
dyad.list <- subset(dyad.list, actor!=subject)
dyad.list$dyadID <- paste(dyad.list$actor, dyad.list$subject, sep="-")

length(dyad.list$dyadID) # 380 dyads with 20 birds
```


## Remove duplicates

We remove duplicates in a more conservative way. We remove duplicates using crowds and displacements combined from the beginning, results in less agonistic events but mistakes per behavior (e.g., entered crowd while it had to be displacement) are excluded. 

See Rmarkdown "Stats_remove duplicates" where we checked whether we did not observe the removed bird during its removal period. WE did not, so we remove duplicates for the whole experimental period combined. 

Time periods:
pre-removal         (bin==1)
removal 1           (bin==2 | bin==3)
reintroduction 1    (bin==4 | bin==5)
removal 2           (bin==6 | bin==7)
reintroduction 2    (bin==8 | bin==9)
removal 3           (bin==10 | bin==11)
reintroduction 3    (bin==12 | bin==13)

removal bins 16-day perturbations (19 birds)
removal 1: BBB (bin==2 | bin==3)
removal 2: GPG (bin==6 | bin==7)
removal 3: OPP (bin==10 | bin==11)

NB: bins 0 and 13 are bordering periods, not used in analyses, expect bin 13 that is used for the recovery measures of the focal bird OPP



```{r remove duplicates}
behave<-behave_raw %>% 
  dplyr::select(-bin) %>%
  rename(bin=rank_assessment)

# check data
unique(behave$behavior)
unique(behave$date)
length(unique(behave$date))
sort(unique(behave$bin)) 
unique(behave$actor)
unique(behave$subject)


#### Remove duplicates for displacements and crowds ####
##more conservative: removing duplicates by crowds and displacements combined
#behave_totalagg<-behave_totalagg_removal

# filter displacement & crowd data from all data
aggDC <- behave

str(aggDC)
length(aggDC$sessionKEY)

# keep only observations where the actor is in the list of bird IDs
aggDC.goodID <- subset(aggDC, actor %in% bird.list) 

# keep only observations where the actor (found above) and the subject are both in the list of bird IDs
aggDC.goodID <- subset(aggDC.goodID, subject %in% bird.list)

sort(unique(aggDC.goodID$actor))
sort(unique(aggDC.goodID$subject))

## for total agonistic events (crowds and displacements combined)
#finds n displacements and crowds by sessionKEY, date, time, actor, subject
dyad.totalagg.key <- aggDC.goodID %>% 
  dplyr::group_by(sessionKEY, bin, date, time,actor, subject) %>%  # removed , behavior
  tally() # counts behaviors that were observed within the same minute

#finds max agg per actor by date, time. Return just that summary
dyad.totalagg.maxkey <- dyad.totalagg.key %>% 
  group_by(actor, subject,bin,  date, time) %>% 
  slice(which.max(n)) %>% # n.aggXaggXkey if summarise, n if tally
  ungroup()
head(dyad.totalagg.maxkey)

#finds n agg per actor by date for summarized/trimmed data
dyad.totalaggXbin <- dyad.totalagg.maxkey %>% 
  group_by(actor, subject, bin) %>% 
  summarise(n.aggXbin=sum(n)) %>% 
  ungroup()
head(dyad.totalaggXbin)


```

```{r save output}
# all periods combined 
glimpse(dyad.totalaggXbin)
length(dyad.totalaggXbin$n.aggXbin)


write.csv(dyad.totalaggXbin, "./output/2021_aginteractions_socialperturb.csv")

```





# Analyses

```{r import data}

dyad.totalaggXbin <- read.csv("./output/2021_aginteractions_socialperturb.csv")

```



## total aggression
```{r}
# summarize total interactions (duplicates included)
behave_agg <- behave %>%
  filter(!bin %in% c(0,13))
unique(behave_agg$bin)

length(behave_agg$behavior)

# summarize total interactions (duplicates excluded)
sum(dyad.totalaggXbin$n.aggXbin)

totalagg <- dyad.totalaggXbin %>%
  filter(!bin %in% c(0, 13)) %>%
  summarize(n.agg = sum(n.aggXbin), n.dyads=length(actor))
totalagg


```


## observation hours
long perturbations 
```{r observation hours }
glimpse(summary)

summ_obs <- summary %>%
  filter(!rank_assessment %in% c(0,13))

sum(summ_obs$obs_days) 
sum(summ_obs$hours_observed) 
sum(summ_obs$person_hours) 

```


## Testing whether removed individuals can re-take their rank
Dominance analyses using crowds and displacements

We have to run the analysis separately for the removal periods (n=19 birds) because the removed birds will otherwise still be present in the dataset

```{r select dataframe}

#dyad.totalaggXbin <- read.csv("./output/2021_aginteractions_socialperturb.csv") %>%
#  dplyr::select(-X)

head(dyad.totalaggXbin)
dyad.totalaggXbin_allbins <- dyad.totalaggXbin

# select period (20 or 19 birds)

## all 20 birds ----
dyad.totalaggXbin <- dyad.totalaggXbin_allbins %>% 
  filter(bin %in% c(0,1,4,5,8,9, 12,13)) # periods with 20 birds

bird.list <- sort(unique(birdIDs$mark_id)) # change each time
length(bird.list)
bird.list

dyad.list <- expand.grid(bird.list, bird.list) #head(dyad.list)
names(dyad.list) <- c("actor", "subject")
dyad.list <- subset(dyad.list, actor!=subject)
dyad.list$dyadID <- paste(dyad.list$actor, dyad.list$subject, sep="-")



## only 19 birds -----
birdIDs_removal1 <- birdIDs %>% filter(mark_id!="BBB")
birdIDs_removal2 <- birdIDs %>% filter(mark_id!="GPG")
birdIDs_removal3 <- birdIDs %>% filter(mark_id!="OPP")

## removal 1: BBB
dyad.totalaggXbin <- dyad.totalaggXbin_allbins %>% 
  filter(bin %in% c(2,3)) # removal 1

bird.list <- sort(unique(birdIDs_removal1$mark_id)) # change each time
length(bird.list)
bird.list

dyad.list <- expand.grid(bird.list, bird.list) #head(dyad.list)
names(dyad.list) <- c("actor", "subject")
dyad.list <- subset(dyad.list, actor!=subject)
dyad.list$dyadID <- paste(dyad.list$actor, dyad.list$subject, sep="-")

## removal 2: GPG
dyad.totalaggXbin <- dyad.totalaggXbin_allbins %>% 
  filter(bin %in% c(6,7)) # removal 2

bird.list <- sort(unique(birdIDs_removal2$mark_id)) # change each time
length(bird.list)
bird.list

dyad.list <- expand.grid(bird.list, bird.list) #head(dyad.list)
names(dyad.list) <- c("actor", "subject")
dyad.list <- subset(dyad.list, actor!=subject)
dyad.list$dyadID <- paste(dyad.list$actor, dyad.list$subject, sep="-")

##  removal 3: OPP
dyad.totalaggXbin <- dyad.totalaggXbin_allbins %>% 
  filter(bin %in% c(10,11)) # removal 3

bird.list <- sort(unique(birdIDs_removal3$mark_id)) # change each time
length(bird.list)
bird.list

dyad.list <- expand.grid(bird.list, bird.list) #head(dyad.list)
names(dyad.list) <- c("actor", "subject")
dyad.list <- subset(dyad.list, actor!=subject)
dyad.list$dyadID <- paste(dyad.list$actor, dyad.list$subject, sep="-")
sort(unique(dyad.totalaggXbin$actor))
sort(unique(dyad.totalaggXbin$subject))








#make matrix function (from dataframe, 1st col with row names)
matrix.please<-function(x) {
  m<-as.matrix(x[,-1])
  rownames(m)<-x[,1]
  m
}

```

### quantify rank
```{r loop for dominance measures}

# check data
sort(unique(dyad.totalaggXbin$actor))
sort(unique(dyad.totalaggXbin$subject))
length(unique(dyad.totalaggXbin$actor))
length(unique(dyad.totalaggXbin$subject))

#### DOMINANCE RANK BY bin####

head(dyad.totalaggXbin)

# make empty data frame to put data in
ec_rank <- data.frame(run.code=character(),
                      bird.list=character(), 
                      dom_ec=numeric(), 
                      rank=numeric())

# run = 1

start.time <- Sys.time()

loopby<-unique(dyad.totalaggXbin$bin)

#i=1

for(i in seq_along(unique(dyad.totalaggXbin$bin))){
  run.code <- loopby[i]
  print(run.code)
  run.data <- subset(dyad.totalaggXbin, bin==run.code)
  
# number of dyads correct?
  #length(run.data$actor)
  #check <- sum.aggXday %>% filter(date==run.code)
  #head(check)
  
  data_alldyads <- merge(dyad.list, run.data, all.x=TRUE,
                       by=c("actor", "subject")) 
  
  #head(data_alldyads)
  #length(unique(data_alldyads$dyadID)) # with 20 birds: 380 dyads
  
  data_alldyads$date<-run.code
  
 #fill newly-merged data with 0's where no interactions
 data_alldyads[is.na(data_alldyads)] <- 0
  
   #print a check
  check <- length(data_alldyads$actor)
  print(check)

# matrix  
  mx <- reshape2::dcast(data_alldyads, actor~subject, value.var="n.aggXbin") #head(ref.behavior1.mx)
  mx[is.na(mx)] <- 0 #for linearity measure, matrix needs to be fully filled, no NAs
  mx <- matrix.please(mx)
  
  ## dominance
  dom_ec <- dom_ec(mx)
  rank <- dom_ranks(dom_ec )

  # combine in dataframe
  pool <- cbind.data.frame(run.code, 
                         bird.list,
                         dom_ec, 
                         rank)

  ec_rank<-rbind(ec_rank, pool )

}

end.time <- Sys.time()

#Time to run:
end.time - start.time

# check
head(ec_rank)
length(unique(ec_rank$run.code))
check <- ec_rank %>% 
  group_by(run.code) %>% 
  summarize(length(bird.list))

ec_rankXbin <- ec_rank %>%
  rename(bin=run.code, id=bird.list) %>%
  group_by(bin) %>%
  mutate(rank=length(id)+1-rank) %>%
  arrange(bin, rank) 



```



```{r combine rank files}
# rename each time
#ec_rankXbin_20birds <- ec_rankXbin
#ec_rankXbin_removal1 <- ec_rankXbin
#ec_rankXbin_removal2 <- ec_rankXbin
#ec_rankXbin_removal3 <- ec_rankXbin

# combine dataframes
ec_rankXbin <- bind_rows(ec_rankXbin_20birds,
                         ec_rankXbin_removal1,
                         ec_rankXbin_removal2,
                         ec_rankXbin_removal3)

# if we do complete dataframe than the removed birds are also included in the removal periods
check <- ec_rankXbin %>%  
  group_by(bin) %>% 
  summarize(length(id))


# sort and flip score, so that higher ranking birds have higher power scores. 
ec_rankXbin <- ec_rankXbin %>%
  arrange(bin) %>%
  mutate(power=1-dom_ec) # power



# save output
#write.csv(ec_rankXbin, "./output/MOPA_power score.csv")

```



### visualise rank over time (excluding removal period)
```{r import dom rank scores}

#powerXbin <- read.csv("./output/MOPA_power score.csv")
#ec_rankXbin <- powerXbin 

unique(sort(ec_rankXbin$bin))

ec_rankXbin %>% group_by(bin) %>% summarise(n=n())

```

remove segment for removed birds:
https://github.com/davidsjoberg/ggbump/wiki/My-year-on-Spotify (example)

BBB ->  (removal bin  2 and 3 
GPG ->  (removal bin  6 and 7
OPP ->  (removal bin  10 and 11

Use long perturbation (both removal and reintroduction) for all birds except focals than add each focal without reintroduction period into plot. 
```{r Fig1. power score over time X rank assessment point}
# flip scores so larger numbers are higher scored 
# remove focal birds from overall plot

head(ec_rankXbin)
glimpse(ec_rankXbin)

bird.list <- sort(unique(birdIDs$mark_id)) # change each time
length(bird.list)
bird.list

# list of all possible dyads
dyad.list <- expand.grid(bird.list, bird.list) #head(dyad.list)
names(dyad.list) <- c("actor", "subject")
dyad.list <- subset(dyad.list, actor!=subject)
dyad.list$dyadID <- paste(dyad.list$actor, dyad.list$subject, sep="-")


# exclude the focal birds
ec_rankXbin_plot_nonfocals <- ec_rankXbin %>% 
  filter(!id %in% c("BBB", "GPG", "OPP"))
unique(ec_rankXbin_plot_nonfocals$id)
length(unique(ec_rankXbin_plot_nonfocals$id))



# custom colors
# Make a palette by drawing pseudo random colors from `RColorBrewer`
set.seed(42)
custom_palette <- c(RColorBrewer::brewer.pal(9, "Set1"),
                    RColorBrewer::brewer.pal(8, "Dark2"),
                    RColorBrewer::brewer.pal(3, "Set2")) %>% 
  sample(n_distinct(ec_rankXbin$id))



# plot (highlight most dominant)
## first plot the nonfocal birds
plot <- ggplot(ec_rankXbin_plot_nonfocals, aes(x=bin, y=power, color=id)) +
  geom_bump(size = 2, smooth = 15, alpha = 0.2) +
  scale_x_continuous( breaks = seq(1,12,1)) +
  scale_y_continuous( breaks = seq(0.80,1.00,0.05)) +
  #scale_y_reverse() +
  scale_colour_manual(values = custom_palette) +
  #ggtitle("dominance: eigenvector centrality") +
  labs(x="rank assessment points", y = "power score") +
  theme_classic() +
  theme(axis.title = element_text(colour = "#2F4858", size = 18),
        axis.text.y=element_text(colour = "#2F4858", size = 18),
        axis.text.x=element_text(colour = "#2F4858", size = 18),
        #axis.ticks.x=element_blank(),
        legend.position = "none",
        #text = element_text(family = "Montserrat", colour = "#2F4858"),
        plot.background = element_rect(fill = "white", colour = "white"),
        #axis.text = element_text(colour = "#2F4858", size = 18), #, face = "bold"
        panel.grid = element_blank(),
        plot.title = element_text(size = 24, face = "bold", hjust = 0.5),
        plot.subtitle = element_text(size = 20, hjust = 0.5, lineheight = 1.15),
        plot.caption = element_text(size = 18), 
        plot.margin = unit(c(1, 1, 0.5, 1), "cm")) 
plot


# now add lines for the focal birds
# BBB removal 2 and 3
plotBBB <- plot + 
  geom_point(data = ec_rankXbin  %>% filter(id=="BBB", bin==1),
             mapping = aes(x=bin, y=power), 
             smooth = 15, size = 6, color = "#1f78b4", inherit.aes = F) +
  geom_point(data = ec_rankXbin  %>% filter(id=="BBB", bin==4),
             mapping = aes(x=bin, y=power), 
             smooth = 15, size = 6, shape = 18, color = "#1f78b4", inherit.aes = F) +
  geom_bump(data = ec_rankXbin %>% filter(id == "BBB", bin<2), 
            mapping = aes(x=bin, y=power), 
            smooth = 15, size = 2, color = "#1f78b4", inherit.aes = F) + 
  geom_bump(data = ec_rankXbin %>% filter(id == "BBB", bin>3), 
            mapping = aes(x=bin, y=power), 
            smooth = 15, size = 2, color = "#1f78b4", inherit.aes = F) +
  #geom_label(data = ec_rankXbin_plot %>% filter(id == "BBB",bin == min(bin)), aes(label = "BBB")) +
  geom_text(data = ec_rankXbin%>% filter(id == "BBB",bin == min(bin) ),
            aes(x = bin - 1.5, label = "BBB"),
            color = "#1f78b4", size = 10, hjust = 0) + #, fontface = "bold"
   #geom_text(data = ec_rankXbin_plot %>% filter(id == "BBB",bin == max(bin) ),
  #          aes(x = bin + .1, label = "BBB"),
  #          color = "#1f78b4", size = 12, hjust = 0, fontface = "bold") +
   geom_vline(xintercept = 1.5, linetype="dashed", color =  alpha("black", 0.6)) +
   geom_vline(xintercept = 3.5, linetype="dotted", color =  alpha("black", 0.6))
    

# GPG removal bin 16 and 17
plotGPG <- plotBBB + #bin %in% c(15,18)
  geom_point(data = ec_rankXbin  %>% filter(id=="GPG", bin==5),
             mapping = aes(x=bin, y=power), 
             smooth = 15, size = 6, color = "#6a51a3", inherit.aes = F) +
  geom_point(data = ec_rankXbin  %>% filter(id=="GPG", bin==8),
             mapping = aes(x=bin, y=power), 
             smooth = 15, size = 6,shape=18, color = "#6a51a3", inherit.aes = F) +
  geom_bump(data = ec_rankXbin %>% filter(id == "GPG", bin<6), 
            mapping = aes(x=bin, y=power), 
            smooth = 15, size = 2, color = "#6a51a3", inherit.aes = F) + 
  geom_bump(data = ec_rankXbin %>% filter(id == "GPG", bin>7), 
            mapping = aes(x=bin, y=power), 
            smooth = 15, size = 2, color = "#6a51a3", inherit.aes = F) +
  #geom_label(data = ec_rankXbin_plot %>% filter(id == "GPG",bin == min(bin)), aes(label = "GPG")) +
  geom_text(data = ec_rankXbin %>% filter(id == "GPG",bin == min(bin) ),
            aes(x = bin - 1.5, label = "GPG"),
            color = "#6a51a3", size = 10, hjust = 0) + #, fontface = "bold"
   #geom_text(data = ec_rankXbin %>% filter(id == "GPG",bin == max(bin) ),
  #          aes(x = bin + .1, label = "GPG"),
  #          color = "#6a51a3", size = 12, hjust = 0, fontface = "bold") +
   geom_vline(xintercept = 5.5, linetype="dashed", color =  alpha("black", 0.6)) +
   geom_vline(xintercept = 7.5, linetype="dotted", color =  alpha("black", 0.6)) 
    

# OPP removal bin 20 and 21
plotOPP <- plotGPG + #bin %in% c(19,21)
  geom_point(data = ec_rankXbin  %>% filter(id=="OPP", bin==9),
             mapping = aes(x=bin, y=power), 
             smooth = 15, size = 6, color = "#ff7f00", inherit.aes = F) +
  geom_point(data = ec_rankXbin  %>% filter(id=="OPP", bin==12),
             mapping = aes(x=bin, y=power), 
             smooth = 15, size = 6, shape = 18, color = "#ff7f00", inherit.aes = F) +
  geom_bump(data = ec_rankXbin %>% filter(id == "OPP", bin<10), 
            mapping = aes(x=bin, y=power), 
            smooth = 15, size = 2, color = "#ff7f00", inherit.aes = F) + 
  geom_bump(data = ec_rankXbin %>% filter(id == "OPP", bin>11), 
            mapping = aes(x=bin, y=power), 
            smooth = 15, size = 2, color = "#ff7f00", inherit.aes = F) +
  #geom_label(data = ec_rankXbin_plot %>% filter(id == "OPP",bin == min(bin)), aes(label = "OPP")) +
  geom_text(data = ec_rankXbin %>% filter(id == "OPP",bin == min(bin) ),
            aes(x = bin - 1.5, label = "OPP"),
            color = "#ff7f00", size = 10, hjust = 0) + #, fontface = "bold"
   #geom_text(data = ec_rankXbin %>% filter(id == "OPP",bin == max(bin) ),
  #          aes(x = bin + .1, label = "OPP"),
  #          color = "#ff7f00", size = 12, hjust = 0, fontface = "bold") +
   geom_vline(xintercept = 9.5, linetype="dashed", color =  alpha("black", 0.6)) +
   geom_vline(xintercept = 11.5, linetype="dotted", color =  alpha("black", 0.6))

plotOPP 

# all combined
ggsave("./figures/Fig1_rank_all+focals.pdf", width = 18, height = 9)

```
We then adjusted the plot in inkscape to include our experimental setup. 


### power score change
A comparison of how much change occurred in all other birds vs the focal. 
A raincloud plot of absolute rank change across all group members except the focal and then a point showing the focal’s absolute change for Supplemental Material
Average power score change vs power score change focal

BBB ->  (removal bin  2 and 3 
GPG ->  (removal bin  6 and 7
OPP ->  (removal bin  10 and 11


```{r Change after reintroduction - before removal}

glimpse(ec_rankXbin) # power = flipped dom_ec score


#Change after reintroduction - before removal
rank_change <- ec_rankXbin %>% 
  dplyr::select(bin, id, power) %>%
  arrange(bin, id) %>%
  group_by(id) %>%
  mutate(lead=lead(power),
         power_change=lead-power) 

```



```{r power score change after removal}

# get data ready per trial
## trial 1 
trial1_rank <- ec_rankXbin %>% 
  filter(bin %in% c(1,4)) %>%
  group_by(id) %>%
  mutate(lead=lead(power),
         power_change=lead-power, 
         rank_lead = lead(rank),
         rank_change=rank_lead-rank, 
         trial=1) %>%
  filter(bin!=4)

trial1_rank_nofocal <- trial1_rank %>%
  filter(id!="BBB") %>% #length(trial1_rank_mean$id)
  mutate(trial=1)  %>%
  dplyr::select(trial, id, power_change, rank_change)

trial1_rank_mean <- mean(abs(trial1_rank_nofocal$power_change))

BBB_rank_change <-  trial1_rank %>%
  filter(id=="BBB") %>%
  mutate(abs_power_change=abs(power_change),
         abs_rank_change=abs(rank_change))


## trial 2
trial2_rank <- ec_rankXbin %>% 
  filter(bin %in% c(5,8)) %>% 
  group_by(id) %>%
  mutate(lead=lead(power),
         power_change=lead-power, 
         rank_lead = lead(rank),
         rank_change=rank_lead-rank, 
         trial=2) %>%
  filter(bin!=8)

trial2_rank_nofocal <- trial2_rank %>%
  filter(id!="GPG") %>% #length(trial2_ran$id)
  dplyr::select(trial, id, power_change, rank_change)

trial2_rank_mean <- mean(abs(trial2_rank_nofocal$power_change))

GPG_rank_change <-  trial2_rank %>%
  filter(id=="GPG") %>%
    mutate(abs_power_change=abs(power_change),
         abs_rank_change=abs(rank_change))

## trial 3
trial3_rank <- ec_rankXbin %>% 
  filter(bin %in% c(9,12)) %>%
  group_by(id) %>%
  mutate(lead=lead(power),
         power_change=lead-power, 
         rank_lead = lead(rank),
         rank_change=rank_lead-rank, 
         trial=3) %>%
  filter(bin!=12)


trial3_rank_nofocal <- trial3_rank %>%
  filter(id!="OPP") %>% #length(trial2_ran$id) %>%
  dplyr::select(trial, id, power_change, rank_change)

trial3_rank_mean <- mean(abs(trial3_rank_nofocal$power_change))

OPP_rank_change <-  trial3_rank %>%
  filter(id=="OPP") %>%
  mutate(abs_power_change=abs(power_change),
         abs_rank_change=abs(rank_change))

## combine data
# absolute power change datasets 
trial_ranks_nofocal <- bind_rows(trial1_rank_nofocal, trial2_rank_nofocal, trial3_rank_nofocal)

trial_ranks <- bind_rows(trial1_rank, trial2_rank, trial3_rank)

trial_ranks_nofocal$order <- factor(trial_ranks_nofocal$trial, 
                                    levels=c(3,2,1))

# summarise 
summ_rankchange <- trial_ranks_nofocal %>%
  group_by(trial) %>%
  summarize(mean=mean(abs(power_change)),
            sd=sd(abs(power_change)),
            n=n())


```

```{r plot supplemental material 1}
# plot: raincloud 
ggplot(trial_ranks_nofocal, aes(x=factor(trial), y=abs(power_change))) +
  ggdist::stat_halfeye(
    ## custom bandwidth
    adjust = .5, 
     ## adjust height
    width = .5,
    height = .5,
    ## move geom to the right
    justification = -.1, 
    ## remove slab interval
    .width = 0, 
    point_colour = NA
  ) +
  geom_boxplot(
    width = .12, 
  ) +
  ggdist::stat_dots(
    layout="weave",
    size=1,
    ## orientation to the left
    side = "left",
    ## move geom to the left
    justification = 1.1, 
    ## adjust grouping (binning) of observations 
    #binwidth = 0.001
  )+
  #scale_y_reverse() +
  #coord_cartesian(ylim = c(0.7, NA)) +
  theme_classic() +
  labs(x= "Trial", y = "absolute power change") +
  annotate('point', x= 0.871, y=BBB_rank_change$abs_power_change, size = 5, color = "#1f78b4" ) +
  annotate('point', x= 1.871, y=GPG_rank_change$abs_power_change, size = 5, color = "#6a51a3") +
  annotate('point', x= 2.871, y=OPP_rank_change$abs_power_change, size = 5, color = "#ff7f00" ) +
  theme(axis.title = element_text(colour = "#2F4858", size = 18),
        axis.text.y=element_text(colour = "#2F4858", size = 18),
        axis.text.x=element_text(colour = "#2F4858", size = 18),
        #axis.ticks.x=element_blank(),
        legend.position = "none",
        #text = element_text(family = "Montserrat", colour = "#2F4858"),
        plot.background = element_rect(fill = "white", colour = "white"),
        #axis.text = element_text(colour = "#2F4858", size = 18), #, face = "bold"
        panel.grid = element_blank(),
        plot.title = element_text(size = 24, face = "bold", hjust = 0.5),
        plot.subtitle = element_text(size = 20, hjust = 0.5, lineheight = 1.15),
        plot.caption = element_text(size = 18), 
        plot.margin = unit(c(1, 1, 0.5, 1), "cm")) 

ggsave("./figures/FigSM2_power_change_raincloud.pdf", width = 6, height = 4)
```

Here, we calculate the power and rank recovery for the focal birds
```{r focal power score recovery after reintroduction}

## trial 1 
trial1_recovery <- ec_rankXbin %>% 
  filter(bin %in% c(5,4), id=="BBB") %>%
  group_by(id) %>%
  mutate(lead=lead(power),
         power_recovery=lead-power, 
         rank_lead = lead(rank),
         rank_recovery=rank_lead-rank)

## trial 2
trial2_recovery <- ec_rankXbin %>% 
  filter(bin %in% c(9,8), id=="GPG") %>%
  group_by(id) %>%
  mutate(lead=lead(power),
         power_recovery=lead-power, 
         rank_lead = lead(rank),
         rank_recovery=rank_lead-rank)

## trial 3
trial3_recovery <- ec_rankXbin %>% 
  filter(bin %in% c(13,12), id=="OPP") %>%
  group_by(id) %>%
  mutate(lead=lead(power),
         power_recovery=lead-power, 
         rank_lead = lead(rank),
         rank_recovery=rank_lead-rank)

```



## Do individual characteristics underly rank?
April 13 

1. is there a correlation between rank and body mass? -> Kendall's tau correlation
2. Does weight at t1 affect rank at t2, etc? -> regression
3. does rank at t2 affect weight at t3, etc? -> regression
4. Is there a correlation between weight change and rank change

or just 
Rank may also affect body weight then manipulating an individual’s rank should result in changes in individual characteristics. 

version April

Is rank determined by body weight or does rank affect body weight? causality of body weight on rank

1. Does current body mass tell anything about rank? Look at the effect of body mass  on rank for 3 day bin prior the social perturbation experiment (rank assessment point 1). Linear regression of rank ~ body mass
  -> yes, current body mass affects rank
2. How much did mass change over initial 44 days and does this mass change influence rank? 
3. rank change ~ body mass change at 3 different timepoints (Bin 1 and 4; bin 5 and 8; bin 9 and 12)




```{r ready data}

# add size of birds (mass)
size_all <- read.csv("./data/morphometrics_focals_2021.csv") 

exp_capture_dates <- c("2021-04-05", "2021-05-19", "2021-06-05", "2021-06-23", "2021-07-05")

size <- size_all %>%
  filter(date %in% exp_capture_dates)

unique(size$date) # 2021-05-19 = capture event for body mass prior social perturbation experiment

length(size$id)

# add sex 
birdID_select <- birdIDs_capture %>%
  dplyr::select(mark_id, sex) %>%
  rename(id=mark_id)



```
Monk parakeets are monomorphic, so first we control whether sex had an effect on rank and body weight

### check weight data

```{r}

# weight bird bag (should be around 145/146 g)
range(size$weight2, na.rm=TRUE)

range(size$weight1) # weight with bag 

# weight of bird (should be between around 110 + or - ~10)
range(size$weight, na.rm=TRUE)


```

IDs with potentially wrong body mass -> exclude:
BBB on 2021-04-05 bird bag weight of 112.08 -> 105.8 (too low)
POP on 2021-06-23 bird bag weight of 129.94 -> 121.4 (too high)
BOB on 2021-07-08 bird bag weight of 169.77 -> 109.1 (too low)

OOO on 2021-06-23 bird weight of 72.82 -> too low (always around 115/120)
BBB on 2021-07-05 bird weight of 86.8 -> very low compared to other weights (always above 110)
PPB on 2021-04-05 bird weight of 86.2 -> very low compared to other weights(always above 100)
PPB on 2021-04-05 bird weight of 89.2 -> very low compared to other weights(always above 110)

```{r remove outlier weights }
size_good <- size %>%
  filter(!weight %in% c(72.82, 86.20, 86.80, 89.20, 109.1, 121.4), weight2!=112.08) %>%  
  drop_na() %>%
  dplyr::select(date, id, weight, perturbation)

unique(size_good$date)

# mean body mass 
mean(size_good$weight)
sd(size_good$weight)
```


### sex effect
```{r}
head(size_good)

# how many females and males?
birdID_select %>%
  group_by(sex) %>%
  summarise(n())

# combine sex to body mass df
size_sex <- size_good %>%
  left_join(birdID_select)

# difference in body mass?
summ_mass <- size_sex %>% 
  group_by(sex) %>%
  summarize(mean= mean(weight, na.rm=TRUE),
            sd = sd(weight, na.rm=TRUE)) 
summ_mass

mean_mass <- size_sex %>%
  group_by(sex, id) %>%
  summarize(mean= mean(weight, na.rm=TRUE),
            sd = sd(weight, na.rm=TRUE)) 

t.test(mean~sex, mean_mass)


# body mass all birds/ males/females
ggplot(size_sex, aes(x=date, y=weight,group=id, color=sex)) +
         geom_point() + geom_line() +
  theme_classic()




```
As we did not find a significant effect we excluded sex from further analyses. 

```{r add power score to mass df}
head(size_sex)

# include bin number to mass df
 size_sex_exp <- size_sex %>%
   separate(perturbation, 
           c("capture", "type"), 
           sep="_", remove = FALSE
             )
head(size_sex_exp)
size_sex_exp$type[size_sex_exp$type=="storm"] <- "end"
 
 # add power score
head(ec_rankXbin)
ec_rankXbin$type[ec_rankXbin$bin==1] <- "removal1"
ec_rankXbin$type[ec_rankXbin$bin==5] <- "removal2"
ec_rankXbin$type[ec_rankXbin$bin==9] <- "removal3"

ec_size_sex <- ec_rankXbin %>% 
  #filter(bin==1) %>% 
  left_join(size_sex_exp, by=c("id", "type")) %>%
  dplyr::select(date,type,  id, sex, weight, rank, dom_ec, power) %>%
  drop_na()

# difference between rank and sex at different time points
#summary(aov(power~sex*type, data = ec_size_sex))
wilcox.test(power~sex, ec_size_sex)

```


### 1. Is there a correlation between body weight and rank when social structure is stable?
Effect of mass on rank when social structure is stable (after 44 days of initial group formation) and just prior the first removal. 

```{r correlation}
head(ec_size_sex)

ranksize_stable <- ec_size_sex %>%
  filter(type=="removal1")

# which distribution does power have
ggplot(data = ranksize_stable , aes(sample = power)) +
  stat_qq() +
  stat_qq_line()


m <- lm(power ~ weight, data =ranksize_stable)
summary(m)
d <- data.frame(residuals = residuals(m),         # Residuals
                std_residuals = rstudent(m), # Studentized Residuals
                fitted = fitted(m),          # Fitted values
                cooks = cooks.distance(m))   # Cook's D
d <- mutate(d, observation = 1:nrow(d))           # Observation number

# histogram of residuals
ggplot(data = d, aes(x = std_residuals)) +
  geom_histogram(bins = 10)

# Check for Normality: QQ Normality plot of residuals
ggplot(data = d, aes(sample = std_residuals)) +
  stat_qq() +
  stat_qq_line()

# Check heteroscedasticity or constant variance
ggplot(d, aes(x = fitted, y = std_residuals)) +
  geom_point() +
  geom_hline(yintercept = 0)

# Cook's D
ggplot(d, aes(x = observation, y = cooks)) +
  geom_point() +
  geom_hline(yintercept = 1, linetype = "dotted") +
  geom_hline(yintercept = 4/nrow(d), linetype = "dashed")
# outliers
d_outliers <- filter(d, cooks > 4/nrow(d))
d_outliers

ranksize_stablee[c(20), ]# no outlier

# which distribution?
range(ranksize_stable$power, na.rm=TRUE)


## correlation ---
cor.test( ranksize_stable$weight,ranksize_stable$power, method = "kendall")


## plot ----
ggplot(ec_size_sex, aes(x = weight, y=power, color = sex)) +
  geom_point() +
  theme_classic() +
  labs(x="body weight (g)", y="power score") +
  #geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) +
  geom_abline(slope = 0.04, intercept = -0.78957)


plot_pwr_weight_bin1 <- ggplot(ranksize_stable, aes(x = weight, y=power)) +
  geom_point() +
  theme_classic() +
  labs(x="body weight (g)", y="power score") 
  #geom_smooth(method="lm" , color="red", fill="#69b3a2", se=TRUE)  #, color="red", fill="#69b3a2", se=TRUE)
 # annotate("text", x = 100, y = 0.99, label = "-0.59 + 0.03x")

#ggsave("./figures/Fig3.bodymass.pdf",  height = 3, width = 3)
  
```
We found a positive correlation between rank and body weight, where heavier birds had higher ranks. 

Now, we are interested in the causality of this relationship: does body mass influence rank or is body mass an outcome of rank? 


### 2. Does body mass influence rank? 
Does body mass predict rank: do heavier birds at t1 (start initial group formation period) obtain higher ranking positions at t2 (rank assessment point 1 just prior first removal), etc? Regression between weight at t1 and rank at t2. 

excluded 3 individuals due to outlier weights 


```{r rank ~ body mass}

# weight t1 - rank t2 ---
weight_t1 <- size_sex_exp %>%
  filter(type=="start")

power_t2 <- ec_rankXbin %>%
  filter(bin ==1) 

weight_pwr <- left_join(weight_t1, power_t2, by="id")

## beta distribution
ggqqplot(weight_pwr, "power")

beta_mass <- betareg(power ~ weight, 
           data = weight_pwr)
beta0 <- betareg(power ~ 1, 
           data = weight_pwr)
lrtest(beta_mass, beta0)

summary(beta_mass)

lrtest(beta0, beta_mass) # no significant effect of weight on rank


# MODEL VALIDATION
model <- beta_mass
1-var(residuals(model)/var(model.response(model.frame(model))))

      
plot(fitted(model), residuals(model), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2) #create a dashed horizontal line representing zero
lines(smooth.spline(fitted(model), residuals(model))) 


# odds ratio
exp(coef(model))
# E.g., The odds of power increases/decreases by a factor of .. (.. times more likely) for every unit increase in x


## plot

ggplot(weight_pwr, aes(x=weight, y=power)) +
  geom_point() +
  theme_classic() +
  labs(x="body weight at time 1 (g)",y="power score at time 2")



# weight t2 - rank t3 ----
weight_t2 <- size_sex_exp %>%
  filter(type=="removal1")

power_t3 <- ec_rankXbin %>%
  filter(bin ==5) 

weight_pwr2 <- left_join(weight_t2, power_t3, by="id")

## beta distribution
beta_mass <- betareg(power ~ weight, 
           data = weight_pwr2)
beta0 <- betareg(power ~ 1, 
           data = weight_pwr2)
lrtest(beta_mass, beta0)

summary(beta_mass)

lrtest(beta0, beta_mass) # no significant effect of weight on rank


# MODEL VALIDATION
model <- beta_mass
1-var(residuals(model)/var(model.response(model.frame(model))))

      
plot(fitted(model), residuals(model), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2) #create a dashed horizontal line representing zero
lines(smooth.spline(fitted(model), residuals(model))) 


# odds ratio
exp(coef(model))
# E.g., The odds of power increases/decreases by a factor of .. (.. times more likely) for every unit increase in x


## plot

ggplot(weight_pwr2, aes(x=weight, y=power)) +
  geom_point() +
  theme_classic() +
  labs(x="body weight at time 2 (g)",y="power score at time 3")




# weight t2 - rank t3 ----
weight_t3 <- size_sex_exp %>%
  filter(type=="removal2")

power_t4 <- ec_rankXbin %>%
  filter(bin ==9) # lst rank assessment point (we don't have bin 13 due to tropical storm)

weight_pwr3 <- left_join(weight_t3, power_t4, by="id")

## beta distribution
beta_mass <- betareg(power ~ weight, 
           data = weight_pwr3)
beta0 <- betareg(power ~ 1, 
           data = weight_pwr3)
lrtest(beta_mass, beta0)

summary(beta_mass)

lrtest(beta0, beta_mass) # no significant effect of weight on rank


# MODEL VALIDATION
model <- beta_mass
1-var(residuals(model)/var(model.response(model.frame(model))))

      
plot(fitted(model), residuals(model), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2) #create a dashed horizontal line representing zero
lines(smooth.spline(fitted(model), residuals(model))) 


# odds ratio
exp(coef(model))
# E.g., The odds of power increases/decreases by a factor of .. (.. times more likely) for every unit increase in x


## plot

ggplot(weight_pwr3, aes(x=weight, y=power)) +
  geom_point() +
  theme_classic() +
  labs(x="body weight at time 3 (g)",y="power score at time 4")


```

Body weight did not predict rank as weight at the start of the field season did not influence rank at the end of the group stabilization period (LRT: 0.19, p = 0.67, estimate +- Sd = 0.01 +- 0.01). We also found nonsignificant results when comparing weight prior to first removal and rank prior to second removal (LRT: 0.13, p = 0.72) and weight prior to second removal and rank prior to third removal (LRT: 0.53, p = 0.47). 


### 3. Is body mass an outcome of rank?


#### focals body mass change
focal birds that were unable to re-take their top rank should also lose weight upon reintroduction: relation between rank loss removal vs weight loss reintroduction. 

in percentage 
body weight gain positive values while weight loss negative values

```{r mass change focals}

focal_weights<- c("capture3","reintroduction1","capture4","reintroduction2","capture5","reintroduction3","capture6")

mass_mean <- size %>% 
  dplyr::select(date, perturbation, id, weight) %>%
  separate(perturbation, 
           c("capture", "type"), 
           sep="_", remove = FALSE
             ) %>% 
  dplyr::filter(capture %in% focal_weights, id %in% c("BBB", "GPG", "OPP")) %>%
  group_by(id) %>%
  arrange(id, date) %>%
  mutate(#weighttime2=lead(weight),
         #masschange=weighttime2-weight, 
         mean=mean(weight)) %>% #,massperc = weight/mean*100
  pivot_wider(-c(date,perturbation, capture),
              names_from = type,
              values_from = weight) %>%
  dplyr::select(id,  mean)

# combine mass change in dataframe
focals <- c("BBB", "GPG", "OPP")
size_focals <- size %>% 
  dplyr::select(date, perturbation, id, weight) %>%
  separate(perturbation, 
           c("capture", "type"), 
           sep="_", remove = FALSE
             ) %>% 
  dplyr::filter(capture %in% focal_weights, id %in% c("BBB", "GPG", "OPP")) %>%
  mutate(weight_t2 = lead(weight), 
    weight_change=weight_t2-weight)


removal_massBBB <- 119.40-119
removal_massGPG <- 114-116.3 
removal_massOPP <- 117.37-116.80
removal_mass <- rbind(removal_massBBB, removal_massGPG, removal_massOPP) 

reintro_massBBB <- 112.8-119.40
reintro_massGPG <- 114.2-114
reintro_massOPP <- 110-117.37
reintro_mass <- rbind(reintro_massBBB, reintro_massGPG, reintro_massOPP) 

#colnames(mass_focals$...3) <- c("reintro")

trial_massBBB <- 112.8-119
trial_massGPG <- 114.20-116.30
trial_massOPP <- 110-116.80
trial_mass <- rbind(trial_massBBB, trial_massGPG, trial_massOPP) 

masschange_focals <- cbind(mass_mean,removal_mass, reintro_mass, trial_mass) %>%
  rename(removal='...3', reintro='...4', trial='...5') %>%
  mutate(perc_removal=removal/mean*100,
         perc_reintro=reintro/mean*100,
         perc_trial=trial/mean*100)



# import created df
focal_masschange <- read.csv("output/focal_mass_change.csv") %>%
  mutate(removal=change_removal/mean*100,
         reintroduction=change_reintroduction/mean*100,
         trial=change_trial/mean*100)

 
# differences in weight change removal
wilcox.test(focal_masschange$start_removal, focal_masschange$upon_reintroduction, 
            paired = TRUE)
# differences in weight change reintroduction
wilcox.test(focal_masschange$upon_reintroduction, focal_masschange$end_trial, 
            paired = TRUE)
# differences in weight change complete trial
wilcox.test(focal_masschange$start_removal, focal_masschange$end_trial, 
            paired = TRUE)

# plot mass change with df in long format
focal_long <- focal_masschange %>%
  dplyr::select(id, removal, reintroduction, trial) %>%
  pivot_longer(-id,
               c("removal", "reintroduction", "trial"),
               names_to = "time",
               values_to = "mass_change")
focal_long$time[focal_long$time==""]<-"removal"

focal_long$period <- factor(focal_long$time, 
                            levels=c("removal", "reintroduction", "trial"))

plot_masschangefocal_removal <- focal_long %>%
  filter(period=="removal") %>%
  ggplot( aes(x=id, y=mass_change, fill=id)) +
  geom_col( colour = "black") +
  scale_y_continuous(limits = c(-7.5, 5.0)) +
  #facet_wrap(~period) +
  labs(x= "perturbed bird ID", y= "weight change (%)", title="8-day removal") +
  theme_classic() +
  scale_fill_manual(values=alpha(c("#1f78b4","#6a51a3","#ff7f00" ),0.6)) +
  geom_hline(yintercept = 0) +
  theme(legend.position = "none")
#ggsave("figures/figure_focal_mass_change_time.pdf")

plot_masschangefocal_reintro <- focal_long %>%
  filter(period=="reintroduction") %>%
  ggplot( aes(x=id, y=mass_change, fill=id)) +
  geom_col( colour = "black") +
  scale_y_continuous(limits = c(-7.5, 5.0)) +
  #facet_wrap(~period) +
  labs(x= "", y= "", title="8-day reintroduction") +
  theme_classic() +
  scale_fill_manual(values=alpha(c("#1f78b4","#6a51a3","#ff7f00" ),0.6)) +
  geom_hline(yintercept = 0) +
  theme(legend.position = "none",
        axis.text.y = element_blank())
#ggsave("figures/figure_focal_mass_change_time.pdf")



```

We found that the focal birds that had an extreme loss of rank (-20 rank positions) upon reintroduction also lost weight after reintroduction (Table 1). Only the focal bird of trial 2 lost 16 rank positions but gained weight after reintroduction. Yet the weight changes were not significant. 

#### regression prior rank and later body mass
Does prior rank influence body mass?
regression between rank t2 and mass t3, t3 vs t2, t4 vs t5

```{r mass ~ rank}

# distribution of body mass ----
x<-size_sex_exp$weight

range(x, na.rm=T)

library(rstatix)
plot(x)
identify(x)
shapiro.test(x)
#anova_test() 

# shapiro test p >0.05, data normally distributed
ggqqplot(size_sex_exp, "weight")


m <- lm(x ~ type, data = size_sex_exp)
summary(m)
d <- data.frame(residuals = residuals(m),         # Residuals
                std_residuals = rstudent(m), # Studentized Residuals
                fitted = fitted(m),          # Fitted values
                cooks = cooks.distance(m))   # Cook's D
d <- mutate(d, observation = 1:nrow(d))           # Observation number

# histogram of residuals
ggplot(data = d, aes(x = std_residuals)) +
  geom_histogram(bins = 10)

# Check for Normality: QQ Normality plot of residuals
ggplot(data = d, aes(sample = std_residuals)) +
  stat_qq() +
  stat_qq_line()

# Check heteroscedasticity or constant variance
ggplot(d, aes(x = fitted, y = std_residuals)) +
  geom_point() +
  geom_hline(yintercept = 0)

# Cook's D
ggplot(d, aes(x = observation, y = cooks)) +
  geom_point() +
  geom_hline(yintercept = 1, linetype = "dotted") +
  geom_hline(yintercept = 4/nrow(d), linetype = "dashed")
# outliers
d_outliers <- filter(d, cooks > 4/nrow(d))
#d_outliers # no outliers when log-transformed; 2,31,33,34


#size_sex_exp[c(75,85,86,89),] # no outliers



# weight t3 - rank t2 ---
weight_t3 <- size_sex_exp %>%
  filter(type=="removal2", id!="BBB") 

power_t2 <- ec_rankXbin %>%
  filter(bin == 1) 

weight_pwr <- left_join(weight_t3, power_t2, by="id")

## normal distribution
m_rank <- lm(weight ~ power, data = weight_pwr)
m0 <- lm(weight ~ 1, data = weight_pwr)

lrtest(m_rank, m0) # no significant effect of rank on weight
summary(m_rank)


## model validation
model <- beta_mass

library(DHARMa)
simulationOutput <- simulateResiduals(fittedModel = model, n = 250)
simulationOutput$scaledResiduals
plot(simulationOutput, asFactor = TRUE)
plotResiduals(weight_pwr$weight, simulationOutput$scaledResiduals, quantreg = T)
simulationOutput = recalculateResiduals(simulationOutput)
testDispersion(simulationOutput)

plot(fitted(model), residuals(model), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2) #create a dashed horizontal line representing zero
lines(smooth.spline(fitted(model), residuals(model))) 


## plot
ggplot(weight_pwr, aes(x=power, y=weight)) +
  geom_point() +
  theme_classic() +
  labs(y="body weight at time 3 (g)",x="power score at time 2")



# weight t4 - rank t3 ----
weight_t4 <- size_sex_exp %>%
  filter(type=="removal3", id!="GPG")

power_t3 <- ec_rankXbin %>%
  filter(bin == 5) 

weight_pwr2 <- left_join(weight_t4, power_t3, by="id")


m_rank <- lm(weight ~ power, data = weight_pwr2)
m0 <- lm(weight ~ 1, data = weight_pwr2)

lrtest(m_rank, m0) # no significant effect of rank on weight
summary(m_rank)

## model validation
model <- m_rank

library(DHARMa)
simulationOutput <- simulateResiduals(fittedModel = model, n = 250)
simulationOutput$scaledResiduals
plot(simulationOutput, asFactor = TRUE)
plotResiduals(weight_pwr$weight, simulationOutput$scaledResiduals, quantreg = T)
simulationOutput = recalculateResiduals(simulationOutput)
testDispersion(simulationOutput)

plot(fitted(model), residuals(model), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2) #create a dashed horizontal line representing zero
lines(smooth.spline(fitted(model), residuals(model))) 

## plot
ggplot(weight_pwr2, aes(y=weight, x=power)) +
  geom_point() +
  theme_classic() +
  labs(y="body weight (g) at time 4",y="power score at time 3")




# weight t5 - rank t4 ----
weight_t5 <- size_sex_exp %>%
  filter(type=="end")

power_t4 <- ec_rankXbin %>%
  filter(bin == 9) 

weight_pwr3 <- left_join(weight_t5, power_t4, by="id")


m_rank <- lm(weight ~ power, data = weight_pwr3)
m0 <- lm(weight ~ 1, data = weight_pwr3)

lrtest(m_rank, m0) # no significant effect of rank on weight
summary(m_rank)

## model validation
model <- m_rank

library(DHARMa)
simulationOutput <- simulateResiduals(fittedModel = model, n = 250)
simulationOutput$scaledResiduals
plot(simulationOutput, asFactor = TRUE)
plotResiduals(weight_pwr$weight, simulationOutput$scaledResiduals, quantreg = T)
simulationOutput = recalculateResiduals(simulationOutput)
testDispersion(simulationOutput)

plot(fitted(model), residuals(model), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2) #create a dashed horizontal line representing zero
lines(smooth.spline(fitted(model), residuals(model))) 

## plot
ggplot(weight_pwr3, aes(y=weight, x=power)) +
  geom_point() +
  theme_classic() +
  labs(y="body weight (g) at time 5",x="power score at time 4")



```

```{r}

weight_power <- bind_rows(weight_pwr, weight_pwr2, weight_pwr3)

# same ids measured at different timepoints
m_int <- lm(weight ~ power * capture, data = weight_power)
m_pwr_trial <- lm(weight ~ power + capture, data = weight_power)
m_pwr <- lm(weight ~ power , data = weight_power)
m_trial <- lm(weight ~ capture, data = weight_power)
m0 <- lm(weight ~ 1 , data = weight_power)

AIC(m_int, m_pwr_trial, m_pwr, m_trial, m0)
lrtest()
summary(m_int)

ggplot(weight_power, aes(power, weight, color=capture)) +
  geom_point() +
  geom_smooth(method="lm", se=F) +
  theme_classic()

```


We did not find that individuals that had higher ranks also had higher body weight the next capture event (LM: )


#### correlation between rank and body mass change
correlation rank change & body mass change at 2 different timepoints 
rank: Bin 1 and 4; bin 5 and 8. Last bin (bin 13) missing due to storm
weight: 


```{r}
head(ec_size_sex)

dsize <- ec_size_sex %>%
  group_by(id) %>% 
  mutate(leadw=lead(weight), 
         weight_change = leadw-weight, 
         leadr=lead(power), 
         power_change = leadr-power) %>% 
  drop_na()
head(dsize)

## trial 1
dsize1 <- dsize %>%
  filter(type=="removal1") #, id!="BBB"

ggplot(dsize1, aes(x=weight_change, y=power_change)) +  # filter(dsize1, id!="BBB")
  geom_point() + 
  theme_classic()

# weight change normally distributed
# shapiro test p >0.05, data normally distributed
ggqqplot(size_sex_exp, "weight")


m <- lm(power_change ~ weight_change, data = dsize1)
summary(m)
d <- data.frame(residuals = residuals(m),         # Residuals
                std_residuals = rstudent(m), # Studentized Residuals
                fitted = fitted(m),          # Fitted values
                cooks = cooks.distance(m))   # Cook's D
d <- mutate(d, observation = 1:nrow(d))           # Observation number

# histogram of residuals
ggplot(data = d, aes(x = std_residuals)) +
  geom_histogram(bins = 10)

# Check for Normality: QQ Normality plot of residuals
ggplot(data = d, aes(sample = std_residuals)) +
  stat_qq() +
  stat_qq_line()

# Check heteroscedasticity or constant variance
ggplot(d, aes(x = fitted, y = std_residuals)) +
  geom_point() +
  geom_hline(yintercept = 0)

# Cook's D
ggplot(d, aes(x = observation, y = cooks)) +
  geom_point() +
  geom_hline(yintercept = 1, linetype = "dotted") +
  geom_hline(yintercept = 4/nrow(d), linetype = "dashed")
# outliers
d_outliers <- filter(d, cooks > 4/nrow(d))
d_outliers # no outliers when log-transformed; 2,31,33,34


cor.test(dsize1$power_change, dsize1$weight_change) # pearson: linearity and constant variance -> no
cor.test(dsize1$power_change, dsize1$weight_change, method="kendall")



## trial 2
dsize2 <- dsize %>%
  filter(type=="removal2", id!="GPG") #, id!="GPG"

ggplot(dsize2, aes(x=weight_change, y=power_change)) +  # filter(dsize1, id!="BBB")
  geom_point() + 
  theme_classic()

# weight change normally distributed
# shapiro test p >0.05, data normally distributed
ggqqplot(dsize2, "weight_change")


m <- lm(power_change ~ weight_change, data = dsize2)
summary(m)
d <- data.frame(residuals = residuals(m),         # Residuals
                std_residuals = rstudent(m), # Studentized Residuals
                fitted = fitted(m),          # Fitted values
                cooks = cooks.distance(m))   # Cook's D
d <- mutate(d, observation = 1:nrow(d))           # Observation number

# histogram of residuals
ggplot(data = d, aes(x = std_residuals)) +
  geom_histogram(bins = 10)

# Check for Normality: QQ Normality plot of residuals
ggplot(data = d, aes(sample = std_residuals)) +
  stat_qq() +
  stat_qq_line()

# Check heteroscedasticity or constant variance
ggplot(d, aes(x = fitted, y = std_residuals)) +
  geom_point() +
  geom_hline(yintercept = 0)

# Cook's D
ggplot(d, aes(x = observation, y = cooks)) +
  geom_point() +
  geom_hline(yintercept = 1, linetype = "dotted") +
  geom_hline(yintercept = 4/nrow(d), linetype = "dashed")
# outliers
d_outliers <- filter(d, cooks > 4/nrow(d))
d_outliers # no outliers when log-transformed; 2,31,33,34


cor.test(dsize2$power_change, dsize2$weight_change) # pearson: linearity and constant variance -> no
cor.test(dsize2$power_change, dsize2$weight_change, method="kendall")


```
For trial 1, power and weight change were positively correlated when the focal bird was included (pearson's = 0.16, p = 0.33) but not when the focal was excluded (pearson's = 0.06, p = 0.7), suggesting that the result was driven by the removal and reintroduction of the focal. 

Power and weight change were not correlated both when the focal was included (trial 1: Kendall's tau = 0.16, p = 0.33, trial 2: kendall's tau = 0.13, p = 0.45) and excluded (trial 1: Kendall's tau = 0.06, p = 0.7; trial 2: kendall's tau = 0.13, p = 0.48) 




### plot

```{r}
ggarrange(plot_pwr_weight_bin1, plot_pwr_change )
```


### mass change stressful

-	Removal stressful from being isolated and away from group -> perhaps couldn’t retake rank, 
o	analyse with change in mass before removal for focal (not significant)
o	compare change in mass between focal and other birds of mass per perturbations. (Mass change in percentage (lose weight -> negative))



#### focals body mass change
in percentage and body weight gain positive values while weight loss negative values
```{r mass change focals}

focal_weights<- c("capture3","reintroduction1","capture4","reintroduction2","capture5","reintroduction3","capture6")

mass_mean <- size %>% 
  dplyr::select(date, perturbation, id, weight) %>%
  separate(perturbation, 
           c("capture", "type"), 
           sep="_", remove = FALSE
             ) %>% 
  dplyr::filter(capture %in% focal_weights, id %in% c("BBB", "GPG", "OPP")) %>%
  group_by(id) %>%
  arrange(id, date) %>%
  mutate(#weighttime2=lead(weight),
         #masschange=weighttime2-weight, 
         mean=mean(weight)) %>% #,massperc = weight/mean*100
  pivot_wider(-c(date,perturbation, capture),
              names_from = type,
              values_from = weight) %>%
  dplyr::select(id,  mean)

# combine mass change in dataframe
focals <- c("BBB", "GPG", "OPP")
size_focals <- size %>% 
  dplyr::select(date, perturbation, id, weight) %>%
  separate(perturbation, 
           c("capture", "type"), 
           sep="_", remove = FALSE
             ) %>% 
  dplyr::filter(capture %in% focal_weights, id %in% c("BBB", "GPG", "OPP")) %>%
  mutate(weight_t2 = lead(weight), 
    weight_change=weight_t2-weight)


removal_massBBB <- 119.40-119
removal_massGPG <- 114-116.3 
removal_massOPP <- 117.37-116.80
removal_mass <- rbind(removal_massBBB, removal_massGPG, removal_massOPP) 

reintro_massBBB <- 112.8-119.40
reintro_massGPG <- 114.2-114
reintro_massOPP <- 110-117.37
reintro_mass <- rbind(reintro_massBBB, reintro_massGPG, reintro_massOPP) 

#colnames(mass_focals$...3) <- c("reintro")

trial_massBBB <- 112.8-119
trial_massGPG <- 114.20-116.30
trial_massOPP <- 110-116.80
trial_mass <- rbind(trial_massBBB, trial_massGPG, trial_massOPP) 

masschange_focals <- cbind(mass_mean,removal_mass, reintro_mass, trial_mass) %>%
  rename(removal='...3', reintro='...4', trial='...5') %>%
  mutate(perc_removal=removal/mean*100,
         perc_reintro=reintro/mean*100,
         perc_trial=trial/mean*100)



# import created df
focal_masschange <- read.csv("output/focal_mass_change.csv") %>%
  mutate(removal=change_removal/mean*100,
         reintroduction=change_reintroduction/mean*100,
         trial=change_trial/mean*100)

 
# differences in weight change removal
wilcox.test(focal_masschange$start_removal, focal_masschange$upon_reintroduction, 
            paired = TRUE)
# differences in weight change reintroduction
wilcox.test(focal_masschange$upon_reintroduction, focal_masschange$end_trial, 
            paired = TRUE)
# differences in weight change complete trial
wilcox.test(focal_masschange$start_removal, focal_masschange$end_trial, 
            paired = TRUE)

# plot mass change with df in long format
focal_long <- focal_masschange %>%
  dplyr::select(id, removal, reintroduction, trial) %>%
  pivot_longer(-id,
               c("removal", "reintroduction", "trial"),
               names_to = "time",
               values_to = "mass_change")
focal_long$time[focal_long$time==""]<-"removal"

focal_long$period <- factor(focal_long$time, 
                            levels=c("removal", "reintroduction", "trial"))

plot_masschangefocal_removal <- focal_long %>%
  filter(period=="removal") %>%
  ggplot( aes(x=id, y=mass_change, fill=id)) +
  geom_col( colour = "black") +
  scale_y_continuous(limits = c(-7.5, 5.0)) +
  #facet_wrap(~period) +
  labs(x= "perturbed bird ID", y= "weight change (%)", title="8-day removal") +
  theme_classic() +
  scale_fill_manual(values=alpha(c("#1f78b4","#6a51a3","#ff7f00" ),0.6)) +
  geom_hline(yintercept = 0) +
  theme(legend.position = "none")
#ggsave("figures/figure_focal_mass_change_time.pdf")

plot_masschangefocal_reintro <- focal_long %>%
  filter(period=="reintroduction") %>%
  ggplot( aes(x=id, y=mass_change, fill=id)) +
  geom_col( colour = "black") +
  scale_y_continuous(limits = c(-7.5, 5.0)) +
  #facet_wrap(~period) +
  labs(x= "", y= "", title="8-day reintroduction") +
  theme_classic() +
  scale_fill_manual(values=alpha(c("#1f78b4","#6a51a3","#ff7f00" ),0.6)) +
  geom_hline(yintercept = 0) +
  theme(legend.position = "none",
        axis.text.y = element_blank())
#ggsave("figures/figure_focal_mass_change_time.pdf")



```


####group vs focal mass change
Exclude focal birds for only their respective trial 
```{r group mass change}
focal_weights<- c("reintroduction1","reintroduction2","reintroduction3")
long_perturb <- c("capture3","capture4","capture5","capture6")

dfmass_long <- size %>% 
  dplyr::select(date, perturbation, id, weight) %>%
              pivot_wider(-date,
              names_from = perturbation,
              values_from = weight)



mass_change_all <- size %>% 
  dplyr::select(date, perturbation, id, weight) %>%
  separate(perturbation, 
           c("capture", "type"), 
           sep="_", remove = FALSE
             ) %>% 
  dplyr::filter(capture %in% long_perturb) %>%
  group_by(id) %>%
  arrange(id, date) %>% 
  mutate(weighttime2=lead(weight),
         masschange=weighttime2-weight, 
         mean=mean(weight)) %>% # ,massperc = masschange/totalavemass*100
  rename(weighttime1=weight)  


# exclude focal birds' mass for their trial

mass_change <- mass_change_all %>%
  filter(!type =="removal1"| !id=="BBB") %>%
  filter(!type =="removal2"| !id=="GPG") %>%
  filter(!type =="removal3"| !id=="OPP")


totalavemass <- mean(mass_change$weighttime1, na.rm=T)


# summarize excluding focals ----

summ_mass <- mass_change %>%
  filter(!id %in% c("BBB", "GPG", "OPP")) %>%
  group_by(type) %>%
  summarize(mean=mean(masschange, na.rm = TRUE), 
            sd=sd(masschange, na.rm = TRUE), 
            n=n())



glimpse(mass_change)
masschange_trials <- mass_change %>% 
  filter(type %in% c("removal1", "removal2", "removal3")) 
masschange_trials$trial <- factor(masschange_trials$type,
                                       levels=c("removal1",
                                                "removal2","removal3"),
                                       labels=c("trial 1",
                                                "trial 2",
                                                "trial 3"))
# stats : distribution ----
x<-masschange_trials$masschange
#x<-masschange_trials_exclout$masschange
range(x, na.rm=T)

library(rstatix)
plot(x)
identify(x)
shapiro.test(x)
#anova_test() 

# shapiro test
masschange_trials %>%
  group_by(type) %>%
  shapiro_test(masschange) # p >0.05, data normally distributed

ggqqplot(masschange_trials, "masschange", facet.by = "type")

#ggplot(data = masschange_trials_exclout , aes(sample = x)) +
#  stat_qq() +
#  stat_qq_line()

#ggplot(masschange_trials_exclout, aes(x = type, y = x)) +
#  geom_point() +
#  stat_smooth(method = "lm")

m <- lm(x ~ type, data = masschange_trials)
summary(m)
d <- data.frame(residuals = residuals(m),         # Residuals
                std_residuals = rstudent(m), # Studentized Residuals
                fitted = fitted(m),          # Fitted values
                cooks = cooks.distance(m))   # Cook's D
d <- mutate(d, observation = 1:nrow(d))           # Observation number

# histogram of residuals
ggplot(data = d, aes(x = std_residuals)) +
  geom_histogram(bins = 10)

# Check for Normality: QQ Normality plot of residuals
ggplot(data = d, aes(sample = std_residuals)) +
  stat_qq() +
  stat_qq_line()

# Check heteroscedasticity or constant variance
ggplot(d, aes(x = fitted, y = std_residuals)) +
  geom_point() +
  geom_hline(yintercept = 0)

# Cook's D
ggplot(d, aes(x = observation, y = cooks)) +
  geom_point() +
  geom_hline(yintercept = 1, linetype = "dotted") +
  geom_hline(yintercept = 4/nrow(d), linetype = "dashed")
# outliers
d_outliers <- filter(d, cooks > 4/nrow(d))
d_outliers # no outliers when log-transformed; 2,31,33,34

masschange_trials_exclout <- masschange_trials[-c(50, 51),] %>%
  ungroup()

masschange_trials %>%
  group_by(type) %>%
  identify_outliers(masschange)

masschange_trials[c(2,31,31,34),] # no outliers


# does body weight change per trial
model<-lmer(masschange ~ type + (1|id), data = masschange_trials)
m0<-lmer(masschange~ 1 + (1|id), data = masschange_trials)

AIC(model, m0)
summary(model)
anova(model, m0)
confint(model)

# Model Diagnostics
plot(fitted(model), residuals(model), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2) #create a dashed horizontal line representing zero
lines(smooth.spline(fitted(model), residuals(model)))

library(DHARMa)
simulationOutput <- simulateResiduals(fittedModel = model, n = 250)
simulationOutput$scaledResiduals
plot(simulationOutput, asFactor = TRUE)
plotResiduals(playback$playback, simulationOutput$scaledResiduals, quantreg = T)
simulationOutput = recalculateResiduals(simulationOutput , group = playback$orderkey)
testDispersion(simulationOutput)


  # plot ----

 set.seed(42)
custom_palette <- c(RColorBrewer::brewer.pal(9, "Set1"),
                    RColorBrewer::brewer.pal(8, "Dark2"),
                    RColorBrewer::brewer.pal(3, "Set2")) %>% 
  sample(n_distinct(mass_change$id))

masschange_trials$comparison <- factor(masschange_trials$type,
                                       levels=c("removal1",
                                                "removal2","removal3"),
                                       labels=c("1 & 2",
                                                "2 & 3",
                                                "3 & final"))

plot_dmass <- masschange_trials %>%
  mutate(perc_change=masschange/mean*100) %>%
  ggplot( aes(x=comparison, y=perc_change)) + 
  geom_hline(yintercept=0) +
   labs(y="weight change (%)",
       x="comparison between capture events", 
       title = "16-day trial period") +
  
  # add half-violin from ggdist package 
  ggdist::stat_halfeye(
    adjust = .5, 
    width = .5, 
    .width = 0, 
    justification = -.3, 
    point_colour = NA) + 
  
  # add boxplot
  geom_boxplot(
    width = .25, 
    outlier.shape = NA) +
  
  # add points in jitter position

 ggdist::stat_dots(
    dotsize = 2,
    side="left",
    justification=1.15,
    binwidth=0.15
  ) +
    # other way to add points
# geom_point(
#    size = 2,
#    alpha = .3,
#    position = position_jitter(
#    seed = 1, width = .15 )) + 
  # highlight focal birds
  #annotate('point', x= .85, y=-5.3264605, size = 4, color = "#1f78b4" ) +
  #annotate('point', x= 1.85, y=-1.8172378, size = 4, color = "#6a51a3") +
  #annotate('point', x= 2.85, y=-5.755201, size = 4, color = "#ff7f00" ) +
  
  # adjust theme and color
  theme_classic() + 
  #scale_color_manual(values= "black") + #alpha(c("#1f78b4","#6a51a3","#ff7f00" ))
  #scale_fill_manual(values=alpha(c("#1f78b4","#6a51a3","#ff7f00" ),0.6))+
  theme(legend.position = "none",
        #axis.text.y = element_blank(),
        axis.text = element_text(), #colour = "#2F4858", size = 24
        axis.title.x = element_text() #colour = "#2F4858", size = 24
        ) +
  coord_cartesian(xlim = c(0.8, NA))
  #scale_fill_tq() +
  #coord_flip() 
  #coord_cartesian(xlim = c(1.2, NA), clip = "off") +
  #geom_text(aes(label = length(playback), y = 10)) +


  plot_dmass
  
#ggsave("./figures/group_weight_change_focalhighlight.pdf")

#       ,width = 90, height = 90, units = "mm")

```


#### combine plots body mass
```{r}


ggarrange(plot_masschangefocal_removal,
          plot_masschangefocal_reintro,
          plot_dmass, 
          nrow=1, 
          labels = c("(a)", "(b)","(c)"))
ggsave("./figures/Fig2_weight_change_updated.pdf",
       width = 180, height = 85, units = "mm") # height = 90 seems to be ok, 60 is too low, 75 just too low


```



# zombie code
version early April
### 1. Does current body weight affect rank?
Effect of mass on rank when social structure is stable (after 44 days of initial group formation) and just prior the first removal. 

```{r linear regression}
head(ec_size_sex)

size_pre <- ec_size_sex %>%
  filter(type=="removal1")

# which distribution does power have
ggplot(data = size_pre , aes(sample = power)) +
  stat_qq() +
  stat_qq_line()


m <- lm(power ~ weight, data =size_pre)
summary(m)
d <- data.frame(residuals = residuals(m),         # Residuals
                std_residuals = rstudent(m), # Studentized Residuals
                fitted = fitted(m),          # Fitted values
                cooks = cooks.distance(m))   # Cook's D
d <- mutate(d, observation = 1:nrow(d))           # Observation number

# histogram of residuals
ggplot(data = d, aes(x = std_residuals)) +
  geom_histogram(bins = 10)

# Check for Normality: QQ Normality plot of residuals
ggplot(data = d, aes(sample = std_residuals)) +
  stat_qq() +
  stat_qq_line()

# Check heteroscedasticity or constant variance
ggplot(d, aes(x = fitted, y = std_residuals)) +
  geom_point() +
  geom_hline(yintercept = 0)

# Cook's D
ggplot(d, aes(x = observation, y = cooks)) +
  geom_point() +
  geom_hline(yintercept = 1, linetype = "dotted") +
  geom_hline(yintercept = 4/nrow(d), linetype = "dashed")
# outliers
d_outliers <- filter(d, cooks > 4/nrow(d))
d_outliers

size_pre[c(20), ]# no outlier

# which distribution?
range(size_pre$power, na.rm=TRUE)


## beta distribution
beta_mass <- betareg(power ~ weight, 
           data = size_pre)
beta0 <- betareg(power ~ 1, 
           data = size_pre)
lrtest(beta_mass, beta0)

summary(beta_mass)

lrtest(beta0, beta_mass) # significant effect of weight on rank


# MODEL VALIDATION
model <- beta_mass
1-var(residuals(model)/var(model.response(model.frame(model))))

      
plot(fitted(model), residuals(model), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2) #create a dashed horizontal line representing zero
lines(smooth.spline(fitted(model), residuals(model))) 


# odds ratio
exp(coef(model))
# E.g., The odds of power increases/decreases by a factor of .. (.. times more likely) for every unit increase in x




## plots ----
ggplot(ec_size_sex, aes(x = weight, y=power, color = sex)) +
  geom_point() +
  theme_classic() +
  labs(x="body weight (g)", y="power score") +
  #geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) +
  geom_abline(slope = 0.04, intercept = -0.78957)


plot_pwr_weight_bin1 <- ggplot(size_pre, aes(x = weight, y=power)) +
  geom_point() +
  theme_classic() +
  labs(x="body weight (g)", y="power score") +
  geom_smooth(method="lm" , color="red", fill="#69b3a2", se=TRUE) + #, color="red", fill="#69b3a2", se=TRUE)
  annotate("text", x = 100, y = 0.99, label = "-0.59 + 0.03x")

ggsave("./figures/Fig3.bodymass.pdf",  height = 3, width = 3)
  
```

### 2. How much did mass change over initial 44 days and does this mass change influence rank? 
excluded 3 individuals due to outlier weights at either timepoint 0 or 1

```{r}
head(size_sex)

dsize <- size_sex %>%
  group_by(id) %>% 
  mutate(lead=lead(weight), 
            weight_change = lead-weight) %>%
  filter(date=="2021-04-05") #slice(1)  # lead is weight at removal1 
head(dsize)

ec_rankbin1 <- ec_rankXbin %>%
  filter(bin==1)

dsize_pwr <- dsize %>%
  left_join(ec_rankbin1)

dsize_pwr_summ <- dsize_pwr %>% ungroup() %>%
  summarise(mean=mean(weight_change),
            sd=sd(weight_change))

ggplot(dsize_pwr, aes(x=weight_change, y=power)) +
  geom_point() +
  theme_classic() +
  labs(x="weight change (g)", y= "power score")

# percent weight change to control for body size
dsize_pwr_mean <- dsize_pwr %>%
  left_join(mean_mass) %>%
  mutate(perc_change = weight_change/mean*100)


# correlation
cor.test(dsize_pwr_mean$perc_change, dsize_pwr_mean$power, method = "spearman" )

plot_pwr_change <- ggplot(dsize_pwr_mean, aes(x=perc_change, y=power)) +
  geom_point() +
  theme_classic() +
  labs(x="weight change (%)", y= "power score")

#
beta_mass <- betareg(power ~ weight*weight_change, 
           data =dsize_pwr)
beta0 <- betareg(power ~ 1, 
           data = size_pre)
lrtest(beta_mass, beta0)

summary(beta_mass)

lrtest(beta0, beta_mass)


ggplot(dsize_pwr, aes(x=lead, y=power, color=weight_change)) +
  geom_point() +
  theme_classic() +
  labs(x="weight (g)", y= "power score") #+
  #geom_smooth(method="lm" ) # , color="red", fill="#69b3a2", se=TRUE


```

### 3. rank change ~ body mass change at 3 different timepoints 
(Bin 1 and 4; bin 5 and 8; bin 9 and 12)




version March

### basics: sex and size 
```{r sex and size basics}

# how many females and males?
birdID_select %>%
  group_by(sex) %>%
  summarise(n())

# mean mass by sex
dfmass <- size_all %>%
  filter(date %in% exp_capture_dates) %>% # 4 captures during social perturbation experiment
  dplyr::select(date, id, weight) %>%
  left_join(birdID_select, by="id") 

mean_mass <- dfmass %>%
  group_by(id) %>%
  summarize(mean= mean(weight, na.rm=TRUE)) %>%
  left_join(birdID_select, by="id") 
t.test(mean~sex, mean_mass)

# mean mass across social perturbation period
dfmass_captures %>% 
  ungroup()%>% 
  filter(trial!="post") %>%
  summarise(mean=mean(weight,na.rm=TRUE),
            sd=sd(weight,na.rm=TRUE),
            n=n(),
            se=sd/sqrt(n), 
            na.rm=TRUE)

mass_sex <- dfmass_captures%>% 
  filter(trial!="post") %>%
  group_by(sex)%>%
  summarise(mean=mean(weight,na.rm=TRUE),
            sd=sd(weight,na.rm=TRUE),
            n=n(),
            se=sd/sqrt(n), 
            na.rm=TRUE)
mass_sex
#wilcox.test(weight ~ sex, data= ec_size_sex)

ec_size_sex_filt <- dfmass_captures %>% 
  ungroup()%>% 
  filter(trial!="post")
t.test(weight ~ sex, data= ec_size_sex_filt)

```
### rank distribution

```{r}

glimpse(ec_size)

id_attr <-  ec_size %>% 
  ungroup() %>% 
  filter(trial!="post", dom_ec!="")

#### all bins excluding focals
# filter out focal birds (could skew the results)
focals <- c("BBB", "GPG", "OPP")
ec_size <- ec_size %>%
  filter(!id %in% focals)

# model diagnostics
ggplot(data = id_attr , aes(sample = dom_ec)) +
  stat_qq() +
  stat_qq_line()

ggplot(id_attr, aes(x = bin, y = dom_ec)) +
  geom_point() +
  stat_smooth(method = "lm")

m <- lm(dom_ec ~ weight, data =id_attr)
summary(m)
d <- data.frame(residuals = residuals(m),         # Residuals
                std_residuals = rstudent(m), # Studentized Residuals
                fitted = fitted(m),          # Fitted values
                cooks = cooks.distance(m))   # Cook's D
d <- mutate(d, observation = 1:nrow(d))           # Observation number

# histogram of residuals
ggplot(data = d, aes(x = std_residuals)) +
  geom_histogram(bins = 10)

# Check for Normality: QQ Normality plot of residuals
ggplot(data = d, aes(sample = std_residuals)) +
  stat_qq() +
  stat_qq_line()

# Check heteroscedasticity or constant variance
ggplot(d, aes(x = fitted, y = std_residuals)) +
  geom_point() +
  geom_hline(yintercept = 0)

# Cook's D
ggplot(d, aes(x = observation, y = cooks)) +
  geom_point() +
  geom_hline(yintercept = 1, linetype = "dotted") +
  geom_hline(yintercept = 4/nrow(d), linetype = "dashed")
# outliers
d_outliers <- filter(d, cooks > 4/nrow(d))
d_outliers

id_attr[c(1), ]
id_attr[c(20), ]
id_attr[c(34), ]

# which distribution?
range(id_attr$dom_ec, na.rm=TRUE)

## beta distribution
```


	
	

###rank ~ mass

We used a generalized mixed model for the effect of size on rank for the bins right before and right after each perturbation event and excluded the bins without weight.

weight at capture 1 for both bin 1 and 2
weight at capture 2 for bins 5 and 6
weight at capture 3 for bins 9 and 10

Check! I get same results for when focal individuals are included and when they are excluded
```{r}
glimpse(ec_size)
sort(unique(ec_size$bin))
ec_size$id <- as.factor(ec_size$id)
ec_size$bin <- as.factor(ec_size$bin)

ec_size_noNA <- ec_size %>%
  filter(weight!="") # , bin %in% c(1,5,9)  , bin %in% c(2,6,10)
  
# beta regression
beta.mass<- glmmadmb(power~ weight +  (1|id) , 
                 data = ec_size_noNA,
                 family="beta")
beta.null <- glmmadmb(power~ 1 +  (1|id), 
                 data = ec_size_noNA,
                 family="beta")
beta.fix <- betareg(power~ weight  , 
                 data = ec_size_noNA)

AIC(beta.mass, beta.null, beta.fix)

summary(beta.massR1)

lrtest(beta.massR1, beta.null)

## excluding focal birds
ecsize <- ec_size %>%
  filter(weight!="", !id %in% c("BBB", "GPG", "OPP")) # , bin %in% c(1,5,9)
unique(ecsize$id)  


beta.mass<- glmmadmb(power~ weight +  (1|id) , 
                 data = ecsize,
                 family="beta")
beta.null <- glmmadmb(power~ 1 +  (1|id), 
                 data = ecsize,
                 family="beta")
beta.fix <- betareg(power~ weight  , 
                 data = ecsize)

AIC(beta.mass, beta.null, beta.fix)

summary(beta.mass)

lrtest(beta.mass, beta.null)

# MODEL VALIDATION
model <- beta.mass
1-var(residuals(model)/var(model.response(model.frame(model))))

      
plot(fitted(model), residuals(model), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2) #create a dashed horizontal line representing zero
lines(smooth.spline(fitted(model), residuals(model))) 


# odds ratio
exp(coef(model))
# E.g., The odds of perching increases/decreases by a factor of .. (.. times more likely) for every unit increase in x

## plot supplemental material----

# with focals
ggplot(ec_size , aes(x=weight, y=flipped_score)) +
  geom_point() +
  theme_classic() +
  labs(x="body weight (g)", y="power score") +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) +
  facet_wrap(~ bin, nrow=3, ncol=2)
  #geom_smooth()
  #geom_abline(slope = -2.38, intercept = -0.17)

ggsave("./figures/plot_rank~mass.pdf")

# without focals
ggplot(ecsize , aes(x=weight, y=flipped_score)) +
  geom_point() +
  theme_classic() +
  labs(x="body weight (g)", y="power score") +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) +
  facet_wrap(~ bin, nrow=3, ncol=2)
  #geom_smooth()
  #geom_abline(slope = -2.38, intercept = -0.17)

ggsave("./figures/FigSM3_rank~mass_nofocals.pdf")

```



### rank ~ sex

Permutations of binning with sex as we want to see per bin whether sex differences exist.

-	Reassign sex for all bins once, find rank for each bin; how does sex correlate with rank (12 correlations). Column for each bin (average correlation of rank on sex for all bins). 

1. Reassign sex for all bins once
2. find rank for each bin
3. regression between sex and rank (12 bins thus 12 regressions)

-> row = sex, column = bins 

4. 	Plot observed correlation on x axis and randomized correlation on y axes  


	regress rank on sex (arrange by power score through reorder funtion within ggplot) then plot by bin and combine plots per trial. 

Anidom::plot_ranks(ranks, plot.CIs = FALSE, ordered.by.rank = TRUE, 
	identities = NULL, plot.identities = TRUE, colors = NULL)

Bins (rank assessment points): 2 and 3, 6 and 7,  10 and 11 -> these are the bins where the focal is removed. 


```{r sex on rank}


# add sex to rank df
ec_sex <- ec_rankXbin %>% 
  group_by(bin) %>%
  left_join(birdID_select, by="id") 

ec_sex_wide <- ec_rankXbin %>% 
  group_by(bin) %>%
  left_join(birdID_select, by="id") %>%
  dplyr::select(id,sex, bin, power) %>%
  arrange(bin) %>%
  pivot_wider(names_from=bin,
              names_prefix = "bin",
              values_from=power)


glimpse(ec_sex_wide)
#sort(unique(ec_sex$bin))
#ec_sex$sex <- as.factor(ec_sex$sex)
#ec_sex$bin <- as.factor(ec_sex$bin)
#ec_sex$id <- as.factor(ec_sex$id)

set.seed(7)
	# Randomise sex
	s <- sample(1:length(ec_sex_wide$id))
	s
	ec_sex$sex.random <- ec_sex_wide$sex[s]

	# long format for loop
	ec_sex_long <- ec_sex_wide %>% 
	  dplyr::select(id, sex,sex.random, everything()) %>%
	  pivot_longer(cols = !c("id", "sex", "sex.random"),
	               names_to = "bin", 
	               values_to = "dom_ec")

# make empty data frame to put data in
sexresult <- data.frame(run.code=character(),
                      obs.coef.sex.lm=numeric(),
                      ran.coef.sex.lm=numeric(),
                      obs.coef.sex.beta=numeric() ,
                      ran.coef.sex.beta=numeric())

# run = 1

start.time <- Sys.time()

loopby<-unique(ec_sex_long$bin)

#i=1

for(i in seq_along(unique(ec_sex_long$bin))){
  run.code <- loopby[i]
  print(run.code)
  run.data <- subset(ec_sex_long , bin==run.code)
  
  obs_sex <- wilcox.test(run.data$dom_ec ~ run.data$sex)
obs.coef.sex.lm <- coefficients(lm(dom_ec ~ sex,
                                   data=run.data))[2]	
ran.coef.sex.lm <- coefficients(lm(dom_ec ~ sex.random,
                                   data=run.data))[2]	

obs.coef.sex.beta <- coefficients(betareg(dom_ec ~ sex, 
                                          data=run.data))[2]	
ran.coef.sex.beta <- coefficients(betareg(dom_ec ~ sex.random, 
                                          data=run.data))[2]

  # combine in dataframe
  pool <- cbind.data.frame(run.code,
                         obs.coef.sex.lm,
                         ran.coef.sex.lm,
                         obs.coef.sex.beta ,
                         ran.coef.sex.beta)

  sexresult <-rbind(sexresult, pool )

}

end.time <- Sys.time()

#Time to run:
end.time - start.time


head(sexresult)

# plot 

# beta regression
cor.test(sexresult$obs.coef.sex.beta, sexresult$ran.coef.sex.beta, method="spearman")
cor(sexresult$obs.coef.sex.beta, sexresult$ran.coef.sex.beta, method="spearman")

ggplot(sexresult, aes(x=obs.coef.sex.beta, y=ran.coef.sex.beta)) +
  geom_point(size=5) +
  theme_classic() + 
  labs(x="observed estimate",
       y="random estimate") +
  theme(text = element_text( colour = "#2F4858"),
        axis.title = element_text(colour = "#2F4858", size = 24),
        axis.text = element_text(colour = "#2F4858", size = 24),
        #axis.text.y=element_blank(), # remove y-axes labels
        #axis.text.x=element_blank(), # remove x-axis labels
        #axis.ticks.x=element_blank(),
        
        #legend.position = "none",
        #legend.text = element_text(colour = "#2F4858", size = 24),
        #legend.title = element_text(colour = "#2F4858", size = 24),
        panel.grid = element_blank(),
        plot.background = element_rect(fill = "white", colour = "white"),
        plot.title = element_text(size = 24, face = "bold", hjust = 0.5),
        plot.subtitle = element_text(size = 20, hjust = 0.5, lineheight = 1.15),
        plot.caption = element_text(size = 10), 
        plot.margin = unit(c(1, 1, 0.5, 1), "cm"))
	ggsave("./output/plot_betareg_sex_rank.pdf", width=8, heigh = 6)
	
# linear regression
cor.test(sexresult$obs.coef.sex.lm, sexresult$ran.coef.sex.lm, method="spearman")
cor(sexresult$obs.coef.sex.lm, sexresult$ran.coef.sex.lm, method="spearman")

mean(sexresult$obs.coef.sex.lm)
mean(sexresult$ran.coef.sex.lm)

	ggplot(sexresult, aes(x=obs.coef.sex.lm, y=ran.coef.sex.lm)) +
  geom_point(size=5) +
  theme_classic() + 
  labs(x="observed estimate",
       y="random estimate") +
  theme(text = element_text( colour = "#2F4858"),
        axis.title = element_text(colour = "#2F4858", size = 24),
        axis.text = element_text(colour = "#2F4858", size = 24),
        #axis.text.y=element_blank(), # remove y-axes labels
        #axis.text.x=element_blank(), # remove x-axis labels
        #axis.ticks.x=element_blank(),
        
        #legend.position = "none",
        #legend.text = element_text(colour = "#2F4858", size = 24),
        #legend.title = element_text(colour = "#2F4858", size = 24),
        panel.grid = element_blank(),
        plot.background = element_rect(fill = "white", colour = "white"),
        plot.title = element_text(size = 24, face = "bold", hjust = 0.5),
        plot.subtitle = element_text(size = 20, hjust = 0.5, lineheight = 1.15),
        plot.caption = element_text(size = 10), 
        plot.margin = unit(c(1, 1, 0.5, 1), "cm"))
	ggsave("./figures/plot_lm_sex_rank.pdf", width=8, heigh = 6)
	

### plot SM4 -----
glimpse(ec_sex)

# plot sex on rank (loop through bins)
#showbins<- c(2,3,6,7,10,11)

loopby <- sort(unique(ec_sex$bin))

i=1


# create a loop to read in your data
for (i in 1:length(loopby)) {
  focal.period <- loopby[i] #extract long name of data file of interest (focal)
  plot.data <- subset(ec_sex, bin==focal.period)

plot_sexXbin <- ggplot(plot.data, 
                       aes(x=reorder(id, -power), y= power, color=sex)) +
  geom_point(size=5) + 
  #scale_y_continuous(limits = c(0.0-0.2)) +
  theme_classic() +
  theme(axis.title = element_blank(),
        #axis.text.y=element_blank(),
        axis.text.x=element_blank(),
        #axis.ticks.x=element_blank(),
        legend.position = "none",
        )

#jpeg(filename= paste("./figures/plot_sexrank_",i,".png", sep= ""))
 #  print(plot_sexXbin)
  # dev.off()

ggsave(paste("./figures/FigSM4_corr_sex_rank",i,".pdf"), width=3, height = 3)

}

```




