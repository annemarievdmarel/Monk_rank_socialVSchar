---
title: "Perturbations monk parakeets"
author: "Annemarie"
date: "23/05/2020"
output:
  pdf_document: default
  html_document: default
---

R code to obtain the dominance hierarchy of 3-day period 
  - Dominance rank 

Figures
1. Rank plot 
2. correlation
3. rank ~ body mass
4. body mass ~ rank :
  a. power and mass change
  b. focal mass changes
  
Supplemental Material
SM1. Experimental schedule and descriptive summary
  -	Number of aggressive events observed
  -	Hours observed
SM2. Justification pooling agonistic behaviors 
SM3. Justification of using body mass as individual characteristic
SM4. Average power score change vs power score change focal



#Load packages
```{r, include=FALSE, echo=FALSE}
library(tidyverse)
library(reshape2)
library(stringr)
library(purrr)
library(domstruc) #install_github("danm0nster/domstruc")
library(ggbump)
library(lubridate)
library(ggthemes)
library(ggrepel)
library(ggpubr)
library(betareg)
library(glmmADMB)
library(lme4)
library(lmtest)
library(pwr)
library(effsize)
library(RColorBrewer)
library(emmeans)

#citation("betareg")

```


# Import data
create novel observation hour dataframe

```{r raw data import, echo=FALSE}
## agonistic interaction data
behave_raw <- read.csv("./data/2021_MOPA_agonistic interactions_longperturb.csv") %>%
  dplyr::select(-X)  # whole field season
glimpse(behave_raw)


# bird list
birdIDs_capture<- read.csv("./data/2021_MOPA_IDs.csv") 
birdIDs <- birdIDs_capture %>%
  dplyr::select(mark_id)

# capture file
size<- read.csv("./data/morphometrics_focals_2021.csv") #%>%
  #dplyr::select(perturbation, date, id, weight)

size_bc <- read.csv("./data/body condition.csv")

# bin dates
bin.dates <- read.csv("./data/2021_3daybins.csv")

# observation hours
#obs_hours <- read.csv("")
```

```{r created data import}

## interaction data
# this is where duplicates are removed and aggression data is summarized by bin
dyad.aggXbin <- read.csv("./output/2021_aginteractions_socialperturb.csv") %>%
  dplyr::select(-X) 

# individual rank X bin
powerXbin <- read.csv("./output/MOPA_power score.csv")


```



# Ready data  

## Helper functions & data
```{r echo=FALSE}

#make matrix function (from dataframe, 1st col with row names)
matrix.please<-function(x) {
  m<-as.matrix(x[,-1])
  rownames(m)<-x[,1]
  m
}


```

## bird list
change for each perturbation as different birds are removed
```{r}
##list of all valid color combinations
# birdIDs$mark_id = all 20 birds
birdIDs_removal1 <- birdIDs %>% filter(mark_id!="BBB")
birdIDs_removal2 <- birdIDs %>% filter(mark_id!="GPG")
birdIDs_removal3 <- birdIDs %>% filter(mark_id!="OPP")

# change each time
bird.list <- sort(unique(birdIDs$mark_id)) 
length(bird.list)
bird.list

# list of all possible dyads
dyad.list <- expand.grid(bird.list, bird.list) #head(dyad.list)
names(dyad.list) <- c("actor", "subject")
dyad.list <- subset(dyad.list, actor!=subject)
dyad.list$dyadID <- paste(dyad.list$actor, dyad.list$subject, sep="-")

length(dyad.list$dyadID) # 380 dyads with 20 birds
```


## Remove duplicates

We remove duplicates in a more conservative way. We remove duplicates using crowds and displacements combined from the beginning, results in less agonistic events but mistakes per behavior (e.g., entered crowd while it had to be displacement) are excluded. 

See Rmarkdown "Stats_remove duplicates" where we checked whether we did not observe the removed bird during its removal period. WE did not, so we remove duplicates for the whole experimental period combined. 

Time periods:
pre-removal         (bin==1)
removal 1           (bin==2 | bin==3)
reintroduction 1    (bin==4 | bin==5)
removal 2           (bin==6 | bin==7)
reintroduction 2    (bin==8 | bin==9)
removal 3           (bin==10 | bin==11)
reintroduction 3    (bin==12 | bin==13)

removal bins 16-day perturbations (19 birds)
removal 1: BBB (bin==2 | bin==3)
removal 2: GPG (bin==6 | bin==7)
removal 3: OPP (bin==10 | bin==11)

NB: bins 0 and 13 are bordering periods, not used in analyses, expect bin 13 that is used for the recovery measures of the focal bird OPP and for figure 1



```{r remove duplicates}
behave<-behave_raw %>% 
  dplyr::select(-bin) %>%
  rename(bin=rank_assessment)

# check data
unique(behave$behavior)
unique(behave$date)
length(unique(behave$date))
sort(unique(behave$bin)) 
unique(behave$actor)
unique(behave$subject)


#### Remove duplicates for displacements and crowds ####
##more conservative: removing duplicates by crowds and displacements combined
#behave_totalagg<-behave_totalagg_removal

# filter displacement & crowd data from all data
aggDC <- behave

str(aggDC)
length(aggDC$sessionKEY)

# keep only observations where the actor is in the list of bird IDs
aggDC.goodID <- subset(aggDC, actor %in% bird.list) 

# keep only observations where the actor (found above) and the subject are both in the list of bird IDs
aggDC.goodID <- subset(aggDC.goodID, subject %in% bird.list)

sort(unique(aggDC.goodID$actor))
sort(unique(aggDC.goodID$subject))

## for total agonistic events (crowds and displacements combined)
#finds n displacements and crowds by sessionKEY, date, time, actor, subject
dyad.totalagg.key <- aggDC.goodID %>% 
  dplyr::group_by(sessionKEY, bin, date, time,actor, subject) %>%  # removed , behavior
  tally() # counts behaviors that were observed within the same minute

#finds max agg per actor by date, time. Return just that summary
dyad.totalagg.maxkey <- dyad.totalagg.key %>% 
  group_by(actor, subject,bin,  date, time) %>% 
  slice(which.max(n)) %>% # n.aggXaggXkey if summarise, n if tally
  ungroup()
#head(dyad.totalagg.maxkey)

#finds n agg per actor by date for summarized/trimmed data
dyad.totalaggXbin <- dyad.totalagg.maxkey %>% 
  group_by(actor, subject, bin) %>% 
  summarise(n.aggXbin=sum(n)) %>% 
  ungroup()
#head(dyad.totalaggXbin)


```

```{r save output}
# all periods combined 
glimpse(dyad.totalaggXbin)
length(dyad.totalaggXbin$n.aggXbin)


write.csv(dyad.totalaggXbin, "./output/2021_aginteractions_socialperturb.csv")

```





# Analyses

```{r import data}

dyad.totalaggXbin <- read.csv("./output/2021_aginteractions_socialperturb.csv")

```



## total aggression
```{r}
# summarize total interactions (duplicates included)
behave_agg <- behave %>%
  filter(!bin %in% c(0))
unique(behave_agg$bin)

length(behave_agg$behavior)

# summarize total interactions (duplicates excluded)
sum(dyad.totalaggXbin$n.aggXbin)

totalagg <- dyad.totalaggXbin %>%
  filter(!bin %in% c(0)) %>%
  summarize(n.agg = sum(n.aggXbin), n.dyads=length(actor))
#totalagg

# agonistic events by bin
agXbin <- dyad.totalaggXbin %>%
  group_by(bin) %>%
  summarize(n.agg = sum(n.aggXbin), n.dyads=length(actor), n.birds=n_distinct(actor))

```


## observation hours
Results are provided in supplemental material 1

redo with just observation hours for rank assessment periods 1-13. 
```{r observation hours }
glimpse(summary)

summ_obs <- summary %>%
  filter(!rank_assessment %in% c(0))

sum(summ_obs$obs_days) 
sum(summ_obs$hours_observed) 
sum(summ_obs$person_hours) 



```


## Testing whether social processes underly rank
Testing whether removed individuals can re-take their rank

Dominance analyses using crowds and displacements

We have to run the analysis separately for the removal periods (n=19 birds) because the removed birds will otherwise still be present in the dataset

```{r select dataframe}

#dyad.totalaggXbin <- read.csv("./output/2021_aginteractions_socialperturb.csv") %>%
#  dplyr::select(-X)

head(dyad.totalaggXbin)
dyad.totalaggXbin_allbins <- dyad.totalaggXbin

# select period (20 or 19 birds)

## all 20 birds ----
dyad.totalaggXbin <- dyad.totalaggXbin_allbins %>% 
  filter(bin %in% c(0,1,4,5,8,9, 12,13)) # periods with 20 birds

bird.list <- sort(unique(birdIDs$mark_id)) # change each time
length(bird.list)
bird.list

dyad.list <- expand.grid(bird.list, bird.list) #head(dyad.list)
names(dyad.list) <- c("actor", "subject")
dyad.list <- subset(dyad.list, actor!=subject)
dyad.list$dyadID <- paste(dyad.list$actor, dyad.list$subject, sep="-")



## only 19 birds -----
birdIDs_removal1 <- birdIDs %>% filter(mark_id!="BBB")
birdIDs_removal2 <- birdIDs %>% filter(mark_id!="GPG")
birdIDs_removal3 <- birdIDs %>% filter(mark_id!="OPP")

## removal 1: BBB
dyad.totalaggXbin <- dyad.totalaggXbin_allbins %>% 
  filter(bin %in% c(2,3)) # removal 1

bird.list <- sort(unique(birdIDs_removal1$mark_id)) # change each time
length(bird.list)
bird.list

dyad.list <- expand.grid(bird.list, bird.list) #head(dyad.list)
names(dyad.list) <- c("actor", "subject")
dyad.list <- subset(dyad.list, actor!=subject)
dyad.list$dyadID <- paste(dyad.list$actor, dyad.list$subject, sep="-")

## removal 2: GPG
dyad.totalaggXbin <- dyad.totalaggXbin_allbins %>% 
  filter(bin %in% c(6,7)) # removal 2

bird.list <- sort(unique(birdIDs_removal2$mark_id)) # change each time
length(bird.list)
bird.list

dyad.list <- expand.grid(bird.list, bird.list) #head(dyad.list)
names(dyad.list) <- c("actor", "subject")
dyad.list <- subset(dyad.list, actor!=subject)
dyad.list$dyadID <- paste(dyad.list$actor, dyad.list$subject, sep="-")

##  removal 3: OPP
dyad.totalaggXbin <- dyad.totalaggXbin_allbins %>% 
  filter(bin %in% c(10,11)) # removal 3

bird.list <- sort(unique(birdIDs_removal3$mark_id)) # change each time
length(bird.list)
bird.list

dyad.list <- expand.grid(bird.list, bird.list) #head(dyad.list)
names(dyad.list) <- c("actor", "subject")
dyad.list <- subset(dyad.list, actor!=subject)
dyad.list$dyadID <- paste(dyad.list$actor, dyad.list$subject, sep="-")
sort(unique(dyad.totalaggXbin$actor))
sort(unique(dyad.totalaggXbin$subject))








#make matrix function (from dataframe, 1st col with row names)
matrix.please<-function(x) {
  m<-as.matrix(x[,-1])
  rownames(m)<-x[,1]
  m
}

```

### quantify rank
```{r loop for dominance measures}

# check data
sort(unique(dyad.totalaggXbin$actor))
sort(unique(dyad.totalaggXbin$subject))
length(unique(dyad.totalaggXbin$actor))
length(unique(dyad.totalaggXbin$subject))

#### DOMINANCE RANK BY bin####

head(dyad.totalaggXbin)

# make empty data frame to put data in
ec_rank <- data.frame(run.code=character(),
                      bird.list=character(), 
                      dom_ec=numeric(), 
                      rank=numeric())

# run = 1

start.time <- Sys.time()

loopby<-unique(dyad.totalaggXbin$bin)

#i=1

for(i in seq_along(unique(dyad.totalaggXbin$bin))){
  run.code <- loopby[i]
  print(run.code)
  run.data <- subset(dyad.totalaggXbin, bin==run.code)
  
# number of dyads correct?
  #length(run.data$actor)
  #check <- sum.aggXday %>% filter(date==run.code)
  #head(check)
  
  data_alldyads <- merge(dyad.list, run.data, all.x=TRUE,
                       by=c("actor", "subject")) 
  
  #head(data_alldyads)
  #length(unique(data_alldyads$dyadID)) # with 20 birds: 380 dyads
  
  data_alldyads$date<-run.code
  
 #fill newly-merged data with 0's where no interactions
 data_alldyads[is.na(data_alldyads)] <- 0
  
   #print a check
  check <- length(data_alldyads$actor)
  print(check)

# matrix  
  mx <- reshape2::dcast(data_alldyads, actor~subject, value.var="n.aggXbin") #head(ref.behavior1.mx)
  mx[is.na(mx)] <- 0 #for linearity measure, matrix needs to be fully filled, no NAs
  mx <- matrix.please(mx)
  
  ## dominance
  dom_ec <- dom_ec(mx)
  rank <- dom_ranks(dom_ec )

  # combine in dataframe
  pool <- cbind.data.frame(run.code, 
                         bird.list,
                         dom_ec, 
                         rank)

  ec_rank<-rbind(ec_rank, pool )

}

end.time <- Sys.time()

#Time to run:
end.time - start.time

# check
head(ec_rank)
length(unique(ec_rank$run.code))
check <- ec_rank %>% 
  group_by(run.code) %>% 
  summarize(length(bird.list))

ec_rankXbin <- ec_rank %>%
  rename(bin=run.code, id=bird.list) %>%
  group_by(bin) %>%
  mutate(rank=length(id)+1-rank) %>%
  arrange(bin, rank) 



```



```{r combine rank files}
# rename each time
#ec_rankXbin_20birds <- ec_rankXbin
#ec_rankXbin_removal1 <- ec_rankXbin
#ec_rankXbin_removal2 <- ec_rankXbin
#ec_rankXbin_removal3 <- ec_rankXbin

# combine dataframes
ec_rankXbin <- bind_rows(ec_rankXbin_20birds,
                         ec_rankXbin_removal1,
                         ec_rankXbin_removal2,
                         ec_rankXbin_removal3)

# if we do complete dataframe than the removed birds are also included in the removal periods
check <- ec_rankXbin %>%  
  group_by(bin) %>% 
  summarize(length(id))


# sort and flip score, so that higher ranking birds have higher power scores. 
ec_rankXbin <- ec_rankXbin %>%
  arrange(bin) %>%
  mutate(power=1-dom_ec) # power



# save output
#write.csv(ec_rankXbin, "./output/MOPA_power score.csv")

```



### visualise rank over time (excluding removal period)
```{r import dom rank scores}

#powerXbin <- read.csv("./output/MOPA_power score.csv")
#ec_rankXbin <- powerXbin 

unique(sort(ec_rankXbin$bin))

ec_rankXbin %>% group_by(bin) %>% summarise(n=n())

```

remove segment for removed birds:
https://github.com/davidsjoberg/ggbump/wiki/My-year-on-Spotify (example)

BBB ->  (removal bin  2 and 3 
GPG ->  (removal bin  6 and 7
OPP ->  (removal bin  10 and 11

Use long perturbation (both removal and reintroduction) for all birds except focals than add each focal without reintroduction period into plot. 
```{r Fig1. power score over time X rank assessment point}
# flip scores so larger numbers are higher scored 
# remove focal birds from overall plot

head(ec_rankXbin)
glimpse(ec_rankXbin)

bird.list <- sort(unique(birdIDs$mark_id)) # change each time
length(bird.list)
bird.list

# list of all possible dyads
dyad.list <- expand.grid(bird.list, bird.list) #head(dyad.list)
names(dyad.list) <- c("actor", "subject")
dyad.list <- subset(dyad.list, actor!=subject)
dyad.list$dyadID <- paste(dyad.list$actor, dyad.list$subject, sep="-")


# exclude the focal birds
ec_rankXbin_plot_nonfocals <- ec_rankXbin %>% 
  filter(!id %in% c("BBB", "GPG", "OPP"))
unique(ec_rankXbin_plot_nonfocals$id)
length(unique(ec_rankXbin_plot_nonfocals$id))



# custom colors
# Make a palette by drawing pseudo random colors from `RColorBrewer`
set.seed(42)
custom_palette <- c(RColorBrewer::brewer.pal(9, "Set1"),
                    RColorBrewer::brewer.pal(8, "Dark2"),
                    RColorBrewer::brewer.pal(3, "Set2")) %>% 
  sample(n_distinct(ec_rankXbin$id))



# plot (highlight most dominant)
## first plot the nonfocal birds
plot <- ggplot(ec_rankXbin_plot_nonfocals, aes(x=bin, y=power, color=id)) +
  geom_bump(size = 2, smooth = 15, alpha = 0.2) +
  scale_x_continuous( breaks = seq(1,12,1)) +
  scale_y_continuous( breaks = seq(0.80,1.00,0.05)) +
  #scale_y_reverse() +
  scale_colour_manual(values = custom_palette) +
  #ggtitle("dominance: eigenvector centrality") +
  labs(x="rank assessment points", y = "power score") +
  theme_classic() +
  theme(axis.title = element_text(colour = "#2F4858", size = 18),
        axis.text.y=element_text(colour = "#2F4858", size = 18),
        axis.text.x=element_text(colour = "#2F4858", size = 18),
        #axis.ticks.x=element_blank(),
        legend.position = "none",
        #text = element_text(family = "Montserrat", colour = "#2F4858"),
        plot.background = element_rect(fill = "white", colour = "white"),
        #axis.text = element_text(colour = "#2F4858", size = 18), #, face = "bold"
        panel.grid = element_blank(),
        plot.title = element_text(size = 24, face = "bold", hjust = 0.5),
        plot.subtitle = element_text(size = 20, hjust = 0.5, lineheight = 1.15),
        plot.caption = element_text(size = 18), 
        plot.margin = unit(c(1, 1, 0.5, 1), "cm")) 
plot


# now add lines for the focal birds
# BBB removal 2 and 3
plotBBB <- plot + 
  geom_point(data = ec_rankXbin  %>% filter(id=="BBB", bin==1),
             mapping = aes(x=bin, y=power), 
             smooth = 15, size = 6, color = "#1f78b4", inherit.aes = F) +
  geom_point(data = ec_rankXbin  %>% filter(id=="BBB", bin==4),
             mapping = aes(x=bin, y=power), 
             smooth = 15, size = 6, shape = 18, color = "#1f78b4", inherit.aes = F) +
  geom_bump(data = ec_rankXbin %>% filter(id == "BBB", bin<2), 
            mapping = aes(x=bin, y=power), 
            smooth = 15, size = 2, color = "#1f78b4", inherit.aes = F) + 
  geom_bump(data = ec_rankXbin %>% filter(id == "BBB", bin>3), 
            mapping = aes(x=bin, y=power), 
            smooth = 15, size = 2, color = "#1f78b4", inherit.aes = F) +
  #geom_label(data = ec_rankXbin_plot %>% filter(id == "BBB",bin == min(bin)), aes(label = "BBB")) +
  geom_text(data = ec_rankXbin%>% filter(id == "BBB",bin == min(bin) ),
            aes(x = bin - 1.5, label = "BBB"),
            color = "#1f78b4", size = 10, hjust = 0) + #, fontface = "bold"
   #geom_text(data = ec_rankXbin_plot %>% filter(id == "BBB",bin == max(bin) ),
  #          aes(x = bin + .1, label = "BBB"),
  #          color = "#1f78b4", size = 12, hjust = 0, fontface = "bold") +
   geom_vline(xintercept = 1.5, linetype="dashed", color =  alpha("black", 0.6)) +
   geom_vline(xintercept = 3.5, linetype="dotted", color =  alpha("black", 0.6))
    

# GPG removal bin 16 and 17
plotGPG <- plotBBB + #bin %in% c(15,18)
  geom_point(data = ec_rankXbin  %>% filter(id=="GPG", bin==5),
             mapping = aes(x=bin, y=power), 
             smooth = 15, size = 6, color = "#6a51a3", inherit.aes = F) +
  geom_point(data = ec_rankXbin  %>% filter(id=="GPG", bin==8),
             mapping = aes(x=bin, y=power), 
             smooth = 15, size = 6,shape=18, color = "#6a51a3", inherit.aes = F) +
  geom_bump(data = ec_rankXbin %>% filter(id == "GPG", bin<6), 
            mapping = aes(x=bin, y=power), 
            smooth = 15, size = 2, color = "#6a51a3", inherit.aes = F) + 
  geom_bump(data = ec_rankXbin %>% filter(id == "GPG", bin>7), 
            mapping = aes(x=bin, y=power), 
            smooth = 15, size = 2, color = "#6a51a3", inherit.aes = F) +
  #geom_label(data = ec_rankXbin_plot %>% filter(id == "GPG",bin == min(bin)), aes(label = "GPG")) +
  geom_text(data = ec_rankXbin %>% filter(id == "GPG",bin == min(bin) ),
            aes(x = bin - 1.5, label = "GPG"),
            color = "#6a51a3", size = 10, hjust = 0) + #, fontface = "bold"
   #geom_text(data = ec_rankXbin %>% filter(id == "GPG",bin == max(bin) ),
  #          aes(x = bin + .1, label = "GPG"),
  #          color = "#6a51a3", size = 12, hjust = 0, fontface = "bold") +
   geom_vline(xintercept = 5.5, linetype="dashed", color =  alpha("black", 0.6)) +
   geom_vline(xintercept = 7.5, linetype="dotted", color =  alpha("black", 0.6)) 
    

# OPP removal bin 20 and 21
plotOPP <- plotGPG + #bin %in% c(19,21)
  geom_point(data = ec_rankXbin  %>% filter(id=="OPP", bin==9),
             mapping = aes(x=bin, y=power), 
             smooth = 15, size = 6, color = "#ff7f00", inherit.aes = F) +
  geom_point(data = ec_rankXbin  %>% filter(id=="OPP", bin==12),
             mapping = aes(x=bin, y=power), 
             smooth = 15, size = 6, shape = 18, color = "#ff7f00", inherit.aes = F) +
  geom_bump(data = ec_rankXbin %>% filter(id == "OPP", bin<10), 
            mapping = aes(x=bin, y=power), 
            smooth = 15, size = 2, color = "#ff7f00", inherit.aes = F) + 
  geom_bump(data = ec_rankXbin %>% filter(id == "OPP", bin>11), 
            mapping = aes(x=bin, y=power), 
            smooth = 15, size = 2, color = "#ff7f00", inherit.aes = F) +
  #geom_label(data = ec_rankXbin_plot %>% filter(id == "OPP",bin == min(bin)), aes(label = "OPP")) +
  geom_text(data = ec_rankXbin %>% filter(id == "OPP",bin == min(bin) ),
            aes(x = bin - 1.5, label = "OPP"),
            color = "#ff7f00", size = 10, hjust = 0) + #, fontface = "bold"
   #geom_text(data = ec_rankXbin %>% filter(id == "OPP",bin == max(bin) ),
  #          aes(x = bin + .1, label = "OPP"),
  #          color = "#ff7f00", size = 12, hjust = 0, fontface = "bold") +
   geom_vline(xintercept = 9.5, linetype="dashed", color =  alpha("black", 0.6)) +
   geom_vline(xintercept = 11.5, linetype="dotted", color =  alpha("black", 0.6))

plotOPP 

# all combined
ggsave("./figures/Fig1_rank_all+focals.pdf", width = 18, height = 9)

```
We then adjusted the plot in inkscape to include our experimental setup. 


### power score change
A comparison of how much change occurred in all other birds vs the focal. 
A raincloud plot of absolute rank change across all group members except the focal and then a point showing the focal’s absolute change for Supplemental Material
Average power score change vs power score change focal

BBB ->  (removal bin  2 and 3 
GPG ->  (removal bin  6 and 7
OPP ->  (removal bin  10 and 11


```{r Change after reintroduction - before removal}

glimpse(ec_rankXbin) # power = flipped dom_ec score


#Change after reintroduction - before removal
rank_change <- ec_rankXbin %>% 
  dplyr::select(bin, id, power) %>%
  arrange(bin, id) %>%
  group_by(id) %>%
  mutate(lead=lead(power),
         power_change=lead-power) 

```



```{r power score change after removal}

ec_rankXbin <- powerXbin
# get data ready per trial
## trial 1 
trial1_rank <- ec_rankXbin %>% 
  filter(bin %in% c(1,4)) %>%
  group_by(id) %>%
  mutate(lead=lead(power),
         power_change=lead-power, 
         rank_lead = lead(rank),
         rank_change=rank_lead-rank, 
         trial=1) %>%
  filter(bin!=4)

trial1_rank_nofocal <- trial1_rank %>%
  filter(id!="BBB") %>% #length(trial1_rank_mean$id)
  mutate(trial=1)  %>%
  dplyr::select(trial, id, power_change, rank_change)

trial1_rank_mean <- mean(abs(trial1_rank_nofocal$power_change))

BBB_rank_change <-  trial1_rank %>%
  filter(id=="BBB") %>%
  mutate(abs_power_change=abs(power_change),
         abs_rank_change=abs(rank_change))


## trial 2
trial2_rank <- ec_rankXbin %>% 
  filter(bin %in% c(5,8)) %>% 
  group_by(id) %>%
  mutate(lead=lead(power),
         power_change=lead-power, 
         rank_lead = lead(rank),
         rank_change=rank_lead-rank, 
         trial=2) %>%
  filter(bin!=8)

trial2_rank_nofocal <- trial2_rank %>%
  filter(id!="GPG") %>% #length(trial2_ran$id)
  dplyr::select(trial, id, power_change, rank_change)

trial2_rank_mean <- mean(abs(trial2_rank_nofocal$power_change))

GPG_rank_change <-  trial2_rank %>%
  filter(id=="GPG") %>%
    mutate(abs_power_change=abs(power_change),
         abs_rank_change=abs(rank_change))

## trial 3
trial3_rank <- ec_rankXbin %>% 
  filter(bin %in% c(9,12)) %>%
  group_by(id) %>%
  mutate(lead=lead(power),
         power_change=lead-power, 
         rank_lead = lead(rank),
         rank_change=rank_lead-rank, 
         trial=3) %>%
  filter(bin!=12)


trial3_rank_nofocal <- trial3_rank %>%
  filter(id!="OPP") %>% #length(trial2_ran$id) %>%
  dplyr::select(trial, id, power_change, rank_change)

trial3_rank_mean <- mean(abs(trial3_rank_nofocal$power_change))

OPP_rank_change <-  trial3_rank %>%
  filter(id=="OPP") %>%
  mutate(abs_power_change=abs(power_change),
         abs_rank_change=abs(rank_change))

## combine data
# absolute power change datasets 
trial_ranks_nofocal <- bind_rows(trial1_rank_nofocal, trial2_rank_nofocal, trial3_rank_nofocal)

trial_ranks <- bind_rows(trial1_rank, trial2_rank, trial3_rank)

trial_ranks_nofocal$order <- factor(trial_ranks_nofocal$trial, 
                                    levels=c(3,2,1))

# summarise 
summ_rankchange <- trial_ranks_nofocal %>%
  group_by(trial) %>%
  summarize(mean=mean(abs(power_change)),
            sd=sd(abs(power_change)),
            n=n())


```

```{r plot supplemental material 1}
# plot: raincloud 
ggplot(trial_ranks_nofocal, aes(x=factor(trial), y=abs(power_change))) +
  ggdist::stat_halfeye(
    ## custom bandwidth
    adjust = .5, 
     ## adjust height
    width = .5,
    height = .5,
    ## move geom to the right
    justification = -.1, 
    ## remove slab interval
    .width = 0, 
    point_colour = NA
  ) +
  geom_boxplot(
    width = .12, 
  ) +
  ggdist::stat_dots(
    layout="weave",
    size=1,
    ## orientation to the left
    side = "left",
    ## move geom to the left
    justification = 1.1, 
    ## adjust grouping (binning) of observations 
    #binwidth = 0.001
  )+
  #scale_y_reverse() +
  #coord_cartesian(ylim = c(0.7, NA)) +
  theme_classic() +
  labs(x= "Trial", y = "absolute power change") +
  annotate('point', x= 0.871, y=BBB_rank_change$abs_power_change, size = 5, color = "#1f78b4" ) +
  annotate('point', x= 1.871, y=GPG_rank_change$abs_power_change, size = 5, color = "#6a51a3") +
  annotate('point', x= 2.871, y=OPP_rank_change$abs_power_change, size = 5, color = "#ff7f00" ) +
  theme(axis.title = element_text(colour = "#2F4858", size = 18),
        axis.text.y=element_text(colour = "#2F4858", size = 18),
        axis.text.x=element_text(colour = "#2F4858", size = 18),
        #axis.ticks.x=element_blank(),
        legend.position = "none",
        #text = element_text(family = "Montserrat", colour = "#2F4858"),
        plot.background = element_rect(fill = "white", colour = "white"),
        #axis.text = element_text(colour = "#2F4858", size = 18), #, face = "bold"
        panel.grid = element_blank(),
        plot.title = element_text(size = 24, face = "bold", hjust = 0.5),
        plot.subtitle = element_text(size = 20, hjust = 0.5, lineheight = 1.15),
        plot.caption = element_text(size = 18), 
        plot.margin = unit(c(1, 1, 0.5, 1), "cm")) 

ggsave("./figures/FigSM2_power_change_raincloud.pdf") #, width = 6, height = 4
```

Here, we calculate the power and rank recovery for the focal birds
```{r focal power score recovery after reintroduction}

## trial 1 
trial1_recovery <- ec_rankXbin %>% 
  filter(bin %in% c(5,4), id=="BBB") %>%
  group_by(id) %>%
  mutate(lead=lead(power),
         power_recovery=lead-power, 
         rank_lead = lead(rank),
         rank_recovery=rank_lead-rank)

## trial 2
trial2_recovery <- ec_rankXbin %>% 
  filter(bin %in% c(9,8), id=="GPG") %>%
  group_by(id) %>%
  mutate(lead=lead(power),
         power_recovery=lead-power, 
         rank_lead = lead(rank),
         rank_recovery=rank_lead-rank)

## trial 3
trial3_recovery <- ec_rankXbin %>% 
  filter(bin %in% c(13,12), id=="OPP") %>%
  group_by(id) %>%
  mutate(lead=lead(power),
         power_recovery=lead-power, 
         rank_lead = lead(rank),
         rank_recovery=rank_lead-rank)

```


## Testing whether individual characteristics underly rank

### check body mass data

```{r ready data}

# add size of birds (mass)
glimpse(size)

exp_capture_dates <- c("2021-04-05", "2021-05-19", "2021-06-05", "2021-06-23", "2021-07-05")

size <- size %>%
  filter(date %in% exp_capture_dates)

unique(size$date) # 2021-05-19 = capture event for body mass prior social perturbation experiment

length(size$id)

# add sex 
birdID_select <- birdIDs_capture %>%
  dplyr::select(mark_id, sex) %>%
  rename(id=mark_id)



```



```{r check body mass}

# weight bird bag (should be around 145/146 g)
range(size$weight2, na.rm=TRUE)

range(size$weight1) # weight with bag 

# weight of bird (should be between around 110 + or - ~10)
range(size$weight, na.rm=TRUE)


```

IDs with potentially wrong body mass -> exclude:
BBB on 2021-04-05 bird bag weight of 112.08 -> 105.8 (too low)
POP on 2021-06-23 bird bag weight of 129.94 -> 121.4 (too high)
BOB on 2021-07-08 bird bag weight of 169.77 -> 109.1 (too low)

OOO on 2021-06-23 bird weight of 72.82 -> too low (always around 115/120)
BBB on 2021-07-05 bird weight of 86.8 -> very low compared to other weights (always above 110)
PPB on 2021-04-05 bird weight of 86.2 -> very low compared to other weights(always above 100)
PPB on 2021-04-05 bird weight of 89.2 -> very low compared to other weights(always above 110)

```{r remove outlier weights }
size_good <- size %>%
  filter(!weight %in% c(72.82, 86.20, 86.80, 89.20, 109.1, 121.4), weight2!=112.08) %>%  
  drop_na() %>%
  dplyr::select(date, id, weight, perturbation) %>%
  left_join(birdID_select)

unique(size_good$date)

# mean body mass 
mean(size_good$weight)
sd(size_good$weight)
```



### correlation body mass and rank
if you drop at a specific time point into the system, do we see an association between power and body mass? 


```{r add power score to mass df}
glimpse(size_good)

# include bin number to mass df
 size_select <- size_good %>%
   separate(perturbation, 
           c("capture", "type"), 
           sep="_", remove = TRUE
             ) %>% 
   dplyr::select(-capture)
#head(size_select)

size_select$type[size_select$type=="storm"] <- "end"
 
 # add power score
glimpse(powerXbin)
powerXbin$type[powerXbin$bin==1] <- "removal1"
powerXbin$type[powerXbin$bin==5] <- "removal2"
powerXbin$type[powerXbin$bin==9] <- "removal3"

power_size <- powerXbin %>% 
  #filter(bin==1) %>% 
  left_join(size_select, by=c("id", "type")) %>%
  dplyr::select(date,type,  id,sex, weight, rank, dom_ec, power) %>%
  drop_na()


```

```{r correlation per trial}

# trial 1
power_size_1 <- power_size %>%
  filter(type=="removal1")

plot_trial1 <- ggplot(power_size_1, aes(x=weight, y=power)) +
  geom_point() +
  theme_classic() +
  scale_y_continuous(limits = c(0.84, 0.98)) +
  #geom_text(aes(label=rank),  nudge_x=0.44, nudge_y=0.001) +
  labs(x="weight (g)", y= "power score", title="Trial 1") 

cor.test(power_size_1$weight, power_size_1$power, method = "kendall")


# trial 2
power_size_2<- power_size %>%
  filter(type=="removal2")

plot_trial2 <- ggplot(power_size_2, aes(x=weight, y=power)) +
  geom_point() +
  theme_classic() +
  scale_y_continuous(limits = c(0.84, 0.98)) +
  #geom_text(aes(label=rank),  nudge_x=0.44, nudge_y=0.001) +
  labs(x="weight (g)", y= "power score", title="Trial 2") 

cor.test(power_size_2$weight, power_size_2$power, method = "kendall")



# trial 3
power_size_3<- power_size %>%
  filter(type=="removal3")

plot_trial3 <- ggplot(power_size_3, aes(x=weight, y=power)) +
  geom_point() +
  theme_classic() +
  #geom_text(aes(label=rank),  nudge_x=0.44, nudge_y=0.001) +
  labs(x="weight (g)", y= "power score", title="Trial 3") 

cor.test(power_size_3$weight, power_size_3$power, method = "kendall")

```
Weight and power are correlated at trial 1 (Kendall's tau = 0.33, p = 0.04), but not at trial 2 (tau = 0.19, p = 0.26) or trial 3 (tau = 0.08, p = 0.65)

#### plot

```{r plot correlations}

power_size$trial <- factor(power_size$type, 
                           levels = c("removal1",
                                      "removal2",
                                      "removal3"),
                           labels = c("Trial 1","Trial 2","Trial 3"))

plot_corr <- ggplot(power_size, 
                    aes(x = weight, y = power, shape = sex, color=sex)) +
  geom_point(size=4, alpha = 0.8) +
  theme_classic() +
  facet_grid(~trial) +
  #geom_text(aes(label=rank),  nudge_x=0.44, nudge_y=0.001) +
  labs(x="weight (g)", y= "power score") +
  theme(legend.position = "bottom") +
  scale_color_manual(values = c("#CACC57","#609A9F"))
plot_corr

ggsave("figures/Fig2.correlation.pdf" ,width = 7, height = 3, units = "in")
```

We did not find a clear pattern that at a specific time point body mass and power were correlated. 

## Determining the direction of causality of rank and mass
Plus, as we found that body mass does not influence rank, could it be that body mass is an outcome of rank. We could test this by correlating power change and weight change for each trial. Does initial weight predict rank after initial group formation period? 

###1. does body mass predict rank?
regression of (weight at 2021-04-05) on power at rank assessment point 1 (prior to removal 1)

```{r ready data}

#head(size_good)

start_weight <- size_good %>%
  filter(date=="2021-04-05")
  
ec_rankbin1 <- powerXbin %>%
  filter(bin==1)

start_size_pwr <- start_weight %>%
  left_join(ec_rankbin1) %>%
  left_join(birdID_select)

## initial plots: power ~ start weight
plot_pwr_startweight <- ggplot(start_size_pwr, aes(x=weight, y=power)) +
  geom_point() +
  theme_classic() +
  labs(x="initial weight (g)", y= "power score")

plot_rank_startweight <- ggplot(start_size_pwr, aes(x=weight, y=rank)) +
  geom_point() +
  theme_classic() +
  labs(x="weight (g)", y= "ordinal rank")



```

Which distribution does power have?

```{r power distribution}

# which distribution does power have
ggplot(data = start_size_pwr , aes(sample = power)) +
  stat_qq() +
  stat_qq_line()


m <- lm(power ~ weight, data = start_size_pwr)
summary(m)

d <- data.frame(residuals = residuals(m),         # Residuals
                std_residuals = rstudent(m), # Studentized Residuals
                fitted = fitted(m),          # Fitted values
                cooks = cooks.distance(m))   # Cook's D
d <- mutate(d, observation = 1:nrow(d))           # Observation number

# histogram of residuals
ggplot(data = d, aes(x = std_residuals)) +
  geom_histogram(bins = 10)

# Check for Normality: QQ Normality plot of residuals
ggplot(data = d, aes(sample = std_residuals)) +
  stat_qq() +
  stat_qq_line()

# Check heteroscedasticity or constant variance
ggplot(d, aes(x = fitted, y = std_residuals)) +
  geom_point() +
  geom_hline(yintercept = 0)

# Cook's D
ggplot(d, aes(x = observation, y = cooks)) +
  geom_point() +
  geom_hline(yintercept = 1, linetype = "dotted") +
  geom_hline(yintercept = 4/nrow(d), linetype = "dashed")
# outliers
d_outliers <- filter(d, cooks > 4/nrow(d))
d_outliers

start_size_pwr[c(8), ]# no outlier

# which distribution? beta 
range(start_size_pwr$power, na.rm=TRUE)


```
Power score follows a beta distribution


```{r regression power ~ body mass}

# power score
beta_mass <- betareg(power ~ weight, 
           data = start_size_pwr)
beta0 <- betareg(power ~ 1, 
           data = start_size_pwr)

lrtest(beta_mass, beta0)

summary(beta_mass)

```

include sex
```{r regression power ~ body mass + sex}

# power score
beta_full <- betareg(power ~ weight+sex, 
           data = start_size_pwr)
beta0 <- betareg(power ~ 1, 
           data = start_size_pwr)
aicresults <- AIC(beta_full, beta0)

lrtest(beta_full, beta0)

summary(beta_full)


```
#### plot 

```{r plot }

plot_priorweight <- ggplot(start_size_pwr, aes(x=weight, y=power)) +
  geom_point(aes( color= sex, shape=sex),size=4, alpha = 0.8) +
  theme_classic() +
  #geom_label(aes(label=rank)) +
  labs(x="initial weight (g)", y= "power score") +
  theme(legend.position = "bottom")  +
  scale_color_manual(values = c("#CACC57","#609A9F"))
  #geom_smooth(method="lm", se=F, color="black") #+
  #geom_smooth(method="lm" ) # , color="red", fill="#69b3a2", se=TRUE
plot_priorweight


ggsave("figures/Fig3.regression.pdf" ,width = 90, height = 60, units = "mm")
```


We found that neither initial body mass nor sex influenced power at the end of the initial group formation period (LRT: λ = 3.85, p = 0.15, weight estimate ± SE = 0.01 ± 0.01, sex estimate ± SE = -0.38 ± 0.19;; Fig. 2TKTK). 

As the birds came from different feral populations, they did not have prior information on all the birds. If body weight influences rank, we should have found a significant relationship between initial body weight and power at a later time point. 


```{r supplemental}
# ordinal rank
rank_mass <- lm(rank ~ weight, 
           data = start_size_pwr)
rank0 <-lm(rank~ 1, 
           data = start_size_pwr)

lrtest(rank_mass, rank0)

summary(rank_mass)



ggplot(start_size_pwr, aes(x=weight, y=rank)) +
  geom_point() +
  theme_classic() +
  labs(x="weight (g)", y= "ordinal rank") #+
  #geom_smooth(method="lm" ) # , color="red", fill="#69b3a2", se=TRUE

```



###2. Is body mass an outcome of rank

weight change between trial capture events
power score change between bin 1 & 5/ bin 5 & 9/ bin 9 & 13 -> however, we do not have power score at rank assessment point 13 due to a tropical storm


We predict that if rank influences body mass that we would see a positive correlation between weight change and power score change. 
```{r correlation power change and weight change}

#head(power_size)
glimpse(power_size)

change <- power_size %>%
  group_by(id) %>% 
  mutate(leadw=lead(weight), 
         weight_change = leadw-weight, 
         leadp=lead(power), 
         power_change = leadp-power, 
         leadr=lead(rank),
         rank_change=rank-leadr) %>% 
  drop_na() %>%
  dplyr::select(type, id,sex, rank,  weight_change, power_change, rank_change)
#head(change)
glimpse(change)

change_summ <- change %>%
  group_by(type) %>%
  summarise(mean_dweight=mean(weight_change),
            mean_dpower=mean(power_change))


## trial 1 ----
dsize1 <- change %>%
  filter(type=="removal1") #, id!="BBB" -> exclude removed focal bird

ggplot(dsize1, aes(x=weight_change, y=power_change)) +  # filter(dsize1, id!="BBB")
  geom_point() + 
  theme_classic()

# weight change normally distributed
# shapiro test p >0.05, data normally distributed
ggqqplot(dsize1, "weight_change")


m <- lm(power_change ~ weight_change, data = dsize1)
m <- lm(weight_change ~ power_change, data = dsize1)
summary(m)
d <- data.frame(residuals = residuals(m),         # Residuals
                std_residuals = rstudent(m), # Studentized Residuals
                fitted = fitted(m),          # Fitted values
                cooks = cooks.distance(m))   # Cook's D
d <- mutate(d, observation = 1:nrow(d))           # Observation number

# histogram of residuals
ggplot(data = d, aes(x = std_residuals)) +
  geom_histogram(bins = 10)

# Check for Normality: QQ Normality plot of residuals
ggplot(data = d, aes(sample = std_residuals)) +
  stat_qq() +
  stat_qq_line()

# Check heteroscedasticity or constant variance
ggplot(d, aes(x = fitted, y = std_residuals)) +
  geom_point() +
  geom_hline(yintercept = 0)

# Cook's D
ggplot(d, aes(x = observation, y = cooks)) +
  geom_point() +
  geom_hline(yintercept = 1, linetype = "dotted") +
  geom_hline(yintercept = 4/nrow(d), linetype = "dashed")
# outliers
d_outliers <- filter(d, cooks > 4/nrow(d))
#d_outliers # no outliers when log-transformed; 2,31,33,34


# correlation
cor.test(dsize1$power_change, dsize1$weight_change, method="kendall")



## trial 2 ----
dsize2 <- change %>%
  filter(type=="removal2") #, id!="GPG"

ggplot(dsize2, aes(x=weight_change, y=power_change)) +  # filter(dsize1, id!="BBB")
  geom_point() + 
  theme_classic()


# normally distributed?
ggqqplot(dsize2, "weight_change")
ggqqplot(dsize2, "power_change")


m <- lm(power_change ~ weight_change, data = dsize2)
summary(m)
d <- data.frame(residuals = residuals(m),         # Residuals
                std_residuals = rstudent(m), # Studentized Residuals
                fitted = fitted(m),          # Fitted values
                cooks = cooks.distance(m))   # Cook's D
d <- mutate(d, observation = 1:nrow(d))           # Observation number

# histogram of residuals
ggplot(data = d, aes(x = std_residuals)) +
  geom_histogram(bins = 10)

# Check for Normality: QQ Normality plot of residuals
ggplot(data = d, aes(sample = std_residuals)) +
  stat_qq() +
  stat_qq_line()

# Check heteroscedasticity or constant variance
ggplot(d, aes(x = fitted, y = std_residuals)) +
  geom_point() +
  geom_hline(yintercept = 0)

# Cook's D
ggplot(d, aes(x = observation, y = cooks)) +
  geom_point() +
  geom_hline(yintercept = 1, linetype = "dotted") +
  geom_hline(yintercept = 4/nrow(d), linetype = "dashed")
# outliers
d_outliers <- filter(d, cooks > 4/nrow(d))
#d_outliers # 1 and 17 -> no outliers


# correlation
cor.test(dsize2$power_change, dsize2$weight_change) # pearson: linearity and constant variance -> no
cor.test(dsize2$power_change, dsize2$weight_change, method="kendall")


```
Power and weight change were not correlated both when the focal was included (trial 1: Kendall's tau = 0.16, p = 0.33; trial 2: kendall's tau = 0.13, p = 0.45) and excluded (trial 1: Kendall's tau = 0.06, p = 0.70; trial 2: kendall's tau = 0.13, p = 0.48) 

```{r % follow prediction}

change1 <- change %>%
  filter(type=="removal1") %>%
  mutate(fits_expectation=if_else(weight_change<0&power_change<0, 'yes', 
                                 if_else(weight_change>0&power_change>0, 'yes', 'no'))) %>%
  group_by(fits_expectation) %>%
  tally() %>%
  mutate (percent_expect = n/20*100)

change2 <- change %>%
  filter(type=="removal2") %>%
  mutate(fits_expectation=if_else(weight_change<0&power_change<0, 'yes', 
                                 if_else(weight_change>0&power_change>0, 'yes', 'no'))) %>%
  group_by(fits_expectation) %>%
  tally() %>%
  mutate (percent_expect = n/20*100)

```



##### plot

add color by rank
Gradient pallette (red top-ranked)
flip rank key, 
bigger poibnt size and slightly transparent, 
move rectanlge to back, 
square off axes, (y= -.15 - 0.15 ..), 
both light grey quadrants as direction of causality we expect the points to fall  in. 
Same line type for 0's,  
legend on the bottom horizontally,
Remove title, 

What percent of birds fall in or outside the 2 quadrants -> would follow our prediction

```{r plot power and weight change}

change$trial <- factor(change$type, 
                           levels = c("removal1",
                                      "removal2"),
                           labels = c("Trial 1","Trial 2"))
change$rank <- as.double(change$rank) 
change <- change %>% ungroup()


library(RColorBrewer)
display.brewer.all()
pal1 <- RColorBrewer::brewer.pal(11, "RdYlBu")
pal2 <- RColorBrewer::brewer.pal(20, "Spectral")


plot_change <- ggplot(change, aes(x=weight_change, y=power_change)) + 
  geom_point( aes(shape=sex, fill=rank), color="black",size=4, alpha = 0.8) + 
  facet_wrap(~trial) +

  theme_classic() +
  theme(legend.position = "bottom")+
  #geom_text(aes(label=rank),  nudge_x=0, nudge_y=0.05) +
  labs(x = "weight change (g)", y = "power score change") + #, title="Change between capture events"
  
  geom_hline(yintercept=0,
             linetype="dashed", color="black") + 
  geom_vline(xintercept=0,
             linetype="dashed", color="black") +
  geom_rect(aes(xmin = 0, xmax = Inf, ymin = 0, ymax = Inf),
                   fill = "grey80", alpha = 0.01, color=alpha("grey",0.01)) +
  geom_rect(aes(xmin = -Inf, xmax = 0, ymin = -Inf, ymax = 0),
                   fill = "grey80", alpha = 0.01, color=alpha("grey", 0.01)) +
  
  scale_y_continuous(limits = c(-0.15, 0.15)) +
  scale_x_continuous(limits = c(-8.5, 8.5)) +
  scale_shape_manual(values=c(21, 24),
                     guide=guide_legend(override.aes = list(fill="black",
                                                            color="black"))) + 
  scale_color_manual(values=c("black", "black", rgb(0, 0, 0, alpha=0))) +
  scale_fill_gradientn(colours = pal2,
                       limits=c(1,20),
                       breaks = c(1, 5, 10, 15, 20)) 

plot_change

ggsave("figures/Fig4.corr change.pdf", width = 7, height = 4, units = "in")

```


```{r plot SM power and weight change + label}

change$trial <- factor(change$type, 
                           levels = c("removal1",
                                      "removal2"),
                           labels = c("Trial 1","Trial 2"))
change$rank <- as.double(change$rank) 
change <- change %>% ungroup()


library(RColorBrewer)
display.brewer.all()
pal1 <- RColorBrewer::brewer.pal(11, "RdYlBu")
pal2 <- RColorBrewer::brewer.pal(20, "Spectral")


plot_SMchange <- ggplot(change, aes(x=weight_change, y=power_change)) + 
  geom_point( aes(shape=sex, fill=rank), color="black",size=4, alpha = 0.8) + 
  facet_wrap(~trial) +

  theme_classic() +
  theme(legend.position = "bottom")+
  geom_text(aes(label=rank),  nudge_x=0, nudge_y=0.02) +
  labs(x = "weight change (g)", y = "power score change") + #, title="Change between capture events"
  
  geom_hline(yintercept=0,
             linetype="dashed", color="black") + 
  geom_vline(xintercept=0,
             linetype="dashed", color="black") +
 # geom_rect(aes(xmin = 0, xmax = Inf, ymin = 0, ymax = Inf),
#                   fill = "grey80", alpha = 0.01, color=alpha("grey",0.01)) +
 # geom_rect(aes(xmin = -Inf, xmax = 0, ymin = -Inf, ymax = 0),
  #                 fill = "grey80", alpha = 0.01, color=alpha("grey", 0.01)) +
  
  scale_y_continuous(limits = c(-0.15, 0.15)) +
  scale_x_continuous(limits = c(-8.5, 8.5)) +
  scale_shape_manual(values=c(21, 24),
                     guide=guide_legend(override.aes = list(fill="black",
                                                            color="black"))) + 
  scale_color_manual(values=c("black", "black", rgb(0, 0, 0, alpha=0))) +
  scale_fill_gradientn(colours = pal2,
                       limits=c(1,20),
                       breaks = c(1, 5, 10, 15, 20)) 

plot_SMchange

ggsave("figures/FigSM.corr change + rank label.pdf")

```

```{r plot corr per trial separate}

library(wesanderson)
pal <- wes_palette("Zissou1", 20, type = "continuous")

library(viridis)
#scale_color_viridis(option = "D", direction = -1)

  guides(
    #reverse color order (higher value on top)
    color = guide_colorbar(reverse = TRUE))

plot_change1 <- ggplot(dsize1, aes(x=weight_change, y=power_change)) +  # filter(dsize1, id!="BBB")
  geom_point(shape=sex) + 
  scale_y_continuous(limits = c(-0.15, 0.10)) +
  theme_classic() +
  #geom_text(aes(label=rank),  nudge_x=0, nudge_y=0.05) +
  labs(x = "weight change (g)", y = "power score change", title="Trial 1") +
  geom_hline(yintercept=0,
             linetype="dotted") + 
  geom_vline(xintercept=0,
             linetype="dashed") 
  #geom_hline(yintercept=change_summ$mean_dpower[change_summ$type=="removal1"],
   #          linetype="dotted") +
  #geom_vline(xintercept=change_summ$mean_dweight[change_summ$type=="removal1"],
   #          linetype="dashed")

  #scale_color_gradient2(midpoint = 10, high = "blue", mid = alpha("yellow",0.2), low = "red")
                  
  #scale_color_gradient(low = "#FF0000",high = "#0000FF") ; #palette = "RdYlBu");  #palette = "Spectral")

plot_change1

plot_change2 <- ggplot(dsize2, aes(x=weight_change, y=power_change)) +  # filter(dsize1, id!="BBB")
  geom_point() + 
  scale_y_continuous(limits = c(-0.15, 0.10)) +
  theme_classic() +
  #geom_text(aes(label=rank),  nudge_x=0, nudge_y=-0.05) +
  labs(x = "weight change (g)", y = "power score change", title="Trial 2") +
  geom_hline(yintercept=0,
             linetype="dotted") + 
  geom_vline(xintercept=0,
             linetype="dashed") 
  #geom_hline(yintercept=change_summ$mean_dpower[change_summ$type=="removal2"],
      #       linetype="dotted") + # mean power change
  #geom_vline(xintercept=change_summ$mean_dweight[change_summ$type=="removal2"],
     #        linetype="dashed") # mean weight change
  
plot_change2

# combine
ggarrange(plot_change1, plot_change2 )
```




#### focals body mass change
focal birds that were unable to re-take their top rank should also lose weight upon reintroduction: relation between rank loss removal vs weight loss reintroduction. 

in percentage 
body weight gain positive values while weight loss negative values

power test 

```{r mass change focals}

focal_weights<- c("capture3","reintroduction1","capture4","reintroduction2","capture5","reintroduction3","capture6")

mass_mean <- size %>% 
  dplyr::select(date, perturbation, id, weight) %>%
  separate(perturbation, 
           c("capture", "type"), 
           sep="_", remove = FALSE
             ) %>% 
  dplyr::filter(capture %in% focal_weights, id %in% c("BBB", "GPG", "OPP")) %>%
  group_by(id) %>%
  arrange(id, date) %>%
  mutate(#weighttime2=lead(weight),
         #masschange=weighttime2-weight, 
         mean=mean(weight)) %>% #,massperc = weight/mean*100
  pivot_wider(-c(date,perturbation, capture),
              names_from = type,
              values_from = weight) %>%
  dplyr::select(id,  mean)

# combine mass change in dataframe
focals <- c("BBB", "GPG", "OPP")
size_focals <- size %>% 
  dplyr::select(date, perturbation, id, weight) %>%
  separate(perturbation, 
           c("capture", "type"), 
           sep="_", remove = FALSE
             ) %>% 
  dplyr::filter(capture %in% focal_weights, id %in% c("BBB", "GPG", "OPP")) %>%
  mutate(weight_t2 = lead(weight), 
    weight_change=weight_t2-weight)


removal_massBBB <- 119.40-119
removal_massGPG <- 114-116.3 
removal_massOPP <- 117.37-116.80
removal_mass <- rbind(removal_massBBB, removal_massGPG, removal_massOPP) 

reintro_massBBB <- 112.8-119.40
reintro_massGPG <- 114.2-114
reintro_massOPP <- 110-117.37
reintro_mass <- rbind(reintro_massBBB, reintro_massGPG, reintro_massOPP) 

#colnames(mass_focals$...3) <- c("reintro")

trial_massBBB <- 112.8-119
trial_massGPG <- 114.20-116.30
trial_massOPP <- 110-116.80
trial_mass <- rbind(trial_massBBB, trial_massGPG, trial_massOPP) 

masschange_focals <- cbind(mass_mean,removal_mass, reintro_mass, trial_mass) %>%
  rename(removal='...3', reintro='...4', trial='...5') %>%
  mutate(perc_removal=removal/mean*100,
         perc_reintro=reintro/mean*100,
         perc_trial=trial/mean*100)



# import created df
focal_masschange <- read.csv("output/focal_mass_change.csv") %>%
  mutate(removal=change_removal/mean*100,
         reintroduction=change_reintroduction/mean*100,
         trial=change_trial/mean*100)

 
# differences in weight change removal
wilcox.test(focal_masschange$start_removal, focal_masschange$upon_reintroduction, 
            paired = TRUE)
t.test(focal_masschange$start_removal, focal_masschange$upon_reintroduction, 
            paired = TRUE)

cd <- cohen.d(focal_masschange$start_removal, focal_masschange$upon_reintroduction, paired = TRUE)
d <- cd$estimate
pwr.t.test(n=3, d= d, sig.level = 0.05, power = NULL,  type=c("paired"))

# differences in weight change reintroduction
wilcox.test(focal_masschange$upon_reintroduction, focal_masschange$end_trial, 
            paired = TRUE)
# differences in weight change complete trial
wilcox.test(focal_masschange$start_removal, focal_masschange$end_trial, 
            paired = TRUE)

# plot mass change with df in long format
focal_long <- focal_masschange %>%
  dplyr::select(id, removal, reintroduction, trial) %>%
  pivot_longer(-id,
               c("removal", "reintroduction", "trial"),
               names_to = "time",
               values_to = "mass_change")
focal_long$time[focal_long$time==""]<-"removal"

focal_long$period <- factor(focal_long$time, 
                            levels=c("removal", "reintroduction", "trial"))

plot_masschangefocal_removal <- focal_long %>%
  filter(period=="removal") %>%
  ggplot( aes(x=id, y=mass_change, fill=id)) +
  geom_col( colour = "black") +
  scale_y_continuous(limits = c(-7.5, 5.0)) +
  #facet_wrap(~period) +
  labs(x= "focal bird ID", y= "weight change (%)", title="following removal") +
  theme_classic() +
  scale_fill_manual(values=alpha(c("#1f78b4","#6a51a3","#ff7f00" ),0.6)) +
  geom_hline(yintercept = 0) +
  theme(legend.position = "none")
#ggsave("figures/figure_focal_mass_change_time.pdf")

plot_masschangefocal_reintro <- focal_long %>%
  filter(period=="reintroduction") %>%
  ggplot( aes(x=id, y=mass_change, fill=id)) +
  geom_col( colour = "black") +
  scale_y_continuous(limits = c(-7.5, 5.0)) +
  #facet_wrap(~period) +
  labs(x= "", y= "", title="following reintroduction") +
  theme_classic() +
  scale_fill_manual(values=alpha(c("#1f78b4","#6a51a3","#ff7f00" ),0.6)) +
  geom_hline(yintercept = 0) +
  theme(legend.position = "none",
        axis.text.y = element_blank())
#ggsave("figures/figure_focal_mass_change_time.pdf")



```

We found that the focal birds that had an extreme loss of rank (-20 rank positions) upon reintroduction also lost weight after reintroduction (Table 1). Only the focal bird of trial 2 lost 16 rank positions but gained weight after reintroduction. Yet the weight changes were not significant. 

####group vs focal mass change
Exclude focal birds for only their respective trial 

check percentage mass change of all birds! 
```{r group mass change}
focal_weights<- c("reintroduction1","reintroduction2","reintroduction3")
long_perturb <- c("capture3","capture4","capture5","capture6")

dfmass_long <- size_good %>% 
  dplyr::select(date, perturbation, id, weight) %>%
              pivot_wider(-date,
              names_from = perturbation,
              values_from = weight)



mass_change_all <- size_good %>% 
  dplyr::select(date, perturbation, id, weight) %>%
  separate(perturbation, 
           c("capture", "type"), 
           sep="_", remove = FALSE
             ) %>% 
  dplyr::filter(capture %in% long_perturb) %>%
  group_by(id) %>%
  arrange(id, date) %>% 
  mutate(weighttime2=lead(weight),
         masschange=weighttime2-weight, 
         mean=mean(weight),
         perc_change=masschange/mean*100) %>% # ,massperc = masschange/totalavemass*100
  rename(weighttime1=weight)  %>%
  drop_na()



# exclude focal birds
mass_change <- mass_change_all %>%
  filter(!id %in% c("BBB", "GPG", "OPP"))

# exclude focal birds' mass for their trial
#  filter(!type =="removal1"| !id=="BBB") %>%
#  filter(!type =="removal2"| !id=="GPG") %>%
#  filter(!type =="removal3"| !id=="OPP")


totalavemass <- mean(mass_change$weighttime1, na.rm=T)


# summarize excluding focals ----

summ_mass <- mass_change %>%
  filter(!id %in% c("BBB", "GPG", "OPP")) %>%
  group_by(type) %>%
  summarize(mean=mean(masschange, na.rm = TRUE), 
            sd=sd(masschange, na.rm = TRUE), 
            n=n())


# stats : distribution ----
x<-mass_change$perc_change
#x<-masschange_trials_exclout$masschange
range(x, na.rm=T)

library(rstatix)
plot(x)
identify(x)
shapiro.test(x)
#anova_test() 

# shapiro test
mass_change %>%
  group_by(type) %>%
  shapiro_test(masschange) # p >0.05, data normally distributed

ggqqplot(mass_change, "perc_change", facet.by = "type")

#ggplot(data = masschange_trials_exclout , aes(sample = x)) +
#  stat_qq() +
#  stat_qq_line()

#ggplot(masschange_trials_exclout, aes(x = type, y = x)) +
#  geom_point() +
#  stat_smooth(method = "lm")

m <- lm(x ~ type, data = mass_change)
summary(m)
d <- data.frame(residuals = residuals(m),         # Residuals
                std_residuals = rstudent(m), # Studentized Residuals
                fitted = fitted(m),          # Fitted values
                cooks = cooks.distance(m))   # Cook's D
d <- mutate(d, observation = 1:nrow(d))           # Observation number

# histogram of residuals
ggplot(data = d, aes(x = std_residuals)) +
  geom_histogram(bins = 10)

# Check for Normality: QQ Normality plot of residuals
ggplot(data = d, aes(sample = std_residuals)) +
  stat_qq() +
  stat_qq_line()

# Check heteroscedasticity or constant variance
ggplot(d, aes(x = fitted, y = std_residuals)) +
  geom_point() +
  geom_hline(yintercept = 0)

# Cook's D
ggplot(d, aes(x = observation, y = cooks)) +
  geom_point() +
  geom_hline(yintercept = 1, linetype = "dotted") +
  geom_hline(yintercept = 4/nrow(d), linetype = "dashed")
# outliers
d_outliers <- filter(d, cooks > 4/nrow(d))
d_outliers 

mass_change[c(1,29,31),] # no outliers
mass_change[c(24,26),] 
#masschange_trials_exclout <- masschange_trials[-c(50, 51),] %>%
#  ungroup()

# does body weight change per trial
model<-lmer(perc_change ~ type + (1|id), data = mass_change)
m0<-lmer(perc_change  ~ 1 + (1|id), data = mass_change)

aic <-AIC(model, m0)
summary(model)
anova(model, m0)
confint(model)

emmeans(model, pairwise ~ type)


# Model Diagnostics
plot(fitted(model), residuals(model), xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, lty = 2) #create a dashed horizontal line representing zero
lines(smooth.spline(fitted(model), residuals(model)))

library(DHARMa)
simulationOutput <- simulateResiduals(fittedModel = model, n = 250)
simulationOutput$scaledResiduals
plot(simulationOutput, asFactor = TRUE)
plotResiduals(playback$playback, simulationOutput$scaledResiduals, quantreg = T)
simulationOutput = recalculateResiduals(simulationOutput , group = playback$orderkey)
testDispersion(simulationOutput)


  # plot ----

 set.seed(42)
custom_palette <- c(RColorBrewer::brewer.pal(9, "Set1"),
                    RColorBrewer::brewer.pal(8, "Dark2"),
                    RColorBrewer::brewer.pal(3, "Set2")) %>% 
  sample(n_distinct(mass_change$id))

mass_change$comparison <- factor(mass_change$type,
                                       levels=c("removal1",
                                                "removal2","removal3"),
                                       labels=c("2 vs 1",
                                                "3 vs 2",
                                                "end vs 3"))

plot_dmass <- mass_change %>%
  ggplot( aes(x=comparison, y=perc_change)) + 
  geom_hline(yintercept=0) +
   labs(y="weight change (%)",
       x="comparison between capture events", 
       title = "between captures") +
  
  # add half-violin from ggdist package 
  ggdist::stat_halfeye(
    adjust = .5, 
    width = .5, 
    .width = 0, 
    justification = -.3, 
    point_colour = NA) + 
  
  # add boxplot
  geom_boxplot(
    width = .25, 
    outlier.shape = NA) +
  
  # add points in jitter position

 ggdist::stat_dots(
    dotsize = 2,
    side="left",
    justification=1.15,
    binwidth=0.15
  ) +
    # other way to add points
# geom_point(
#    size = 2,
#    alpha = .3,
#    position = position_jitter(
#    seed = 1, width = .15 )) + 
  # highlight focal birds
  #annotate('point', x= .85, y=-5.3264605, size = 4, color = "#1f78b4" ) +
  #annotate('point', x= 1.85, y=-1.8172378, size = 4, color = "#6a51a3") +
  #annotate('point', x= 2.85, y=-5.755201, size = 4, color = "#ff7f00" ) +
  
  # adjust theme and color
  theme_classic() + 
  #scale_color_manual(values= "black") + #alpha(c("#1f78b4","#6a51a3","#ff7f00" ))
  #scale_fill_manual(values=alpha(c("#1f78b4","#6a51a3","#ff7f00" ),0.6))+
  theme(legend.position = "none",
        #axis.text.y = element_blank(),
        axis.text = element_text(), #colour = "#2F4858", size = 24
        axis.title.x = element_text() #colour = "#2F4858", size = 24
        ) +
  coord_cartesian(xlim = c(0.8, NA)) +
  scale_y_continuous(limits = c(-7.5, 5.0)) 
  #scale_fill_tq() +
  #coord_flip() 
  #coord_cartesian(xlim = c(1.2, NA), clip = "off") +
  #geom_text(aes(label = length(playback), y = 10)) +


  plot_dmass
  
#ggsave("./figures/group_weight_change_focalhighlight.pdf")

#       ,width = 90, height = 90, units = "mm")
  
  


```

##### plot
```{r}
ggarrange(plot_masschangefocal_removal,
          plot_masschangefocal_reintro,
          plot_dmass, 
          nrow=1, 
          labels = c("(a)", "(b)","(c)"))

ggsave("./figures/Fig4.pdf",
       width = 180, height = 85, units = "mm") # height = 90 seems to be ok, 60 is too low, 75 just too low
```


# Supplemental Material: culmen width

## Testing whether body size or condition underly rank

```{r}
glimpse(size_bc)

size_good <- size_bc %>% 
  dplyr::select(-sex, -X) %>%
  filter(weight!="72.8") %>%  
  left_join(birdID_select)

unique(size_good$date)

# culmen width
mean(size_good$culmen_width)
sd(size_good$culmen_width)

# body condition
mean(size_good$bc)
sd(size_good$bc)
```


### correlation body size/condition and rank
if you drop at a specific time point into the system, do we see an association between power and body mass? 


```{r add power score to mass df}


# include bin number to mass df
 size_select <- size_good %>%
   separate(perturbation, 
           c("capture", "type"), 
           sep="_", remove = TRUE
             ) %>% 
   dplyr::select(-capture)
#head(size_select)

size_select$type[size_select$type=="startshort"] <- "end"
 
 # add power score
glimpse(powerXbin)
powerXbin$type[powerXbin$bin==1] <- "removal1"
powerXbin$type[powerXbin$bin==5] <- "removal2"
powerXbin$type[powerXbin$bin==9] <- "removal3"

power_size <- powerXbin %>% 
  #filter(bin==1) %>% 
  right_join(size_select, by=c("id", "type")) %>%
  dplyr::select(date,type, id,sex, weight, culmen_width, bc,rank, dom_ec, power) %>%
  drop_na()


```


Culmen width correlation
```{r}

mean_cw <- size_select %>%
  group_by(id) %>%
  summarize(meancw=mean(culmen_width))

power_size_1 <- power_size %>%
  filter(type=="removal1") %>%
  left_join(mean_cw)

ggplot(power_size_1, aes(x=meancw, y=power)) +
  geom_point() +
  theme_classic() +
  scale_y_continuous(limits = c(0.84, 0.98)) +
  #geom_text(aes(label=rank),  nudge_x=0.44, nudge_y=0.001) +
  labs(x="culmen width (mm)", y= "power score", title="") 

cor.test(power_size_1$meancw, power_size_1$power, method = "kendall")

```



```{r correlation per trial}

# trial 1
power_size_1 <- power_size %>%
  filter(type=="removal1")

plot_trial1 <- ggplot(power_size_1, aes(x=bc, y=power)) +
  geom_point() +
  theme_classic() +
  scale_y_continuous(limits = c(0.84, 0.98)) +
  #geom_text(aes(label=rank),  nudge_x=0.44, nudge_y=0.001) +
  labs(x="body condition", y= "power score", title="Trial 1") 

cor.test(power_size_1$bc, power_size_1$power, method = "kendall")

# trial 2
power_size_2<- power_size %>%
  filter(type=="removal2")

plot_trial2 <- ggplot(power_size_2, aes(x=bc, y=power)) +
  geom_point() +
  theme_classic() +
  scale_y_continuous(limits = c(0.84, 0.98)) +
  #geom_text(aes(label=rank),  nudge_x=0.44, nudge_y=0.001) +
  labs(x="body condition", y= "power score", title="Trial 2") 

cor.test(power_size_2$bc, power_size_2$power, method = "kendall")


# trial 3
power_size_3<- power_size %>%
  filter(type=="removal3")

plot_trial3 <- ggplot(power_size_3, aes(x=bc, y=power)) +
  geom_point() +
  theme_classic() +
  #geom_text(aes(label=rank),  nudge_x=0.44, nudge_y=0.001) +
  labs(x="body condition", y= "power score", title="Trial 3") 

cor.test(power_size_3$bc, power_size_3$power, method = "kendall")

```
Body condition and power are correlated at trial 1 (Kendall's tau = 0.33, p = 0.05), but not at trial 2 (tau = 0.08, p = 0.63) or trial 3 (tau = 0.09, p = 0.65)

#### plot

```{r plot correlations}

power_size$trial <- factor(power_size$type, 
                           levels = c("removal1",
                                      "removal2",
                                      "removal3"),
                           labels = c("Trial 1","Trial 2","Trial 3"))

plot_corr <- ggplot(power_size, 
                    aes(x = bc, y = power, shape = sex, color=sex)) +
  geom_point(size=4, alpha = 0.8) +
  theme_classic() +
  facet_grid(~trial) +
  #geom_text(aes(label=rank),  nudge_x=0.44, nudge_y=0.001) +
  labs(x="body condition", y= "power score") +
  theme(legend.position = "bottom")
plot_corr

ggsave("figures/SM.correlation.pdf" ,width = 7, height = 3, units = "in")
```

We did not find a clear pattern that at a specific time point body condition and power were correlated. 

## Determining the direction of causality of rank and body condition
Plus, as we found that body mass does not influence rank, could it be that body mass is an outcome of rank. We could test this by correlating power change and weight change for each trial. Does initial weight predict rank after initial group formation period? 

###1. does body condition predict rank?
regression of (bc at 2021-04-05) on power at rank assessment point 1 (prior to removal 1)

```{r ready data}

#head(size_good)

start <- size_good %>%
  filter(date=="2021-04-05")
  
ec_rankbin1 <- powerXbin %>%
  filter(bin==1)

start_size_pwr <- start%>%
  left_join(ec_rankbin1) %>%
  left_join(birdID_select)

## initial plots: power ~ start weight
plot_pwr_startbc <- ggplot(start_size_pwr, aes(x=bc, y=power)) +
  geom_point() +
  theme_classic() +
  labs(x="initial body condition", y= "power score")




```

Which distribution does power have?

```{r power distribution}

# which distribution does power have
ggplot(data = start_size_pwr , aes(sample = power)) +
  stat_qq() +
  stat_qq_line()


m <- lm(power ~ bc, data = start_size_pwr)
summary(m)

d <- data.frame(residuals = residuals(m),         # Residuals
                std_residuals = rstudent(m), # Studentized Residuals
                fitted = fitted(m),          # Fitted values
                cooks = cooks.distance(m))   # Cook's D
d <- mutate(d, observation = 1:nrow(d))           # Observation number

# histogram of residuals
ggplot(data = d, aes(x = std_residuals)) +
  geom_histogram(bins = 10)

# Check for Normality: QQ Normality plot of residuals
ggplot(data = d, aes(sample = std_residuals)) +
  stat_qq() +
  stat_qq_line()

# Check heteroscedasticity or constant variance
ggplot(d, aes(x = fitted, y = std_residuals)) +
  geom_point() +
  geom_hline(yintercept = 0)

# Cook's D
ggplot(d, aes(x = observation, y = cooks)) +
  geom_point() +
  geom_hline(yintercept = 1, linetype = "dotted") +
  geom_hline(yintercept = 4/nrow(d), linetype = "dashed")
# outliers
d_outliers <- filter(d, cooks > 4/nrow(d))
d_outliers

start_size_pwr[c(8), ]# no outlier

# which distribution? beta 
range(start_size_pwr$power, na.rm=TRUE)


```
Power score follows a beta distribution


```{r regression power ~ body condition}

# power score
beta_bc <- betareg(power ~ bc, 
           data = start_size_pwr)
beta0 <- betareg(power ~ 1, 
           data = start_size_pwr)

lrtest(beta_bc, beta0)

summary(beta_bc)

```

include sex
```{r regression power ~ body mass + sex}

# power score
beta_full <- betareg(power ~ bc+sex, 
           data = start_size_pwr)
beta0 <- betareg(power ~ 1, 
           data = start_size_pwr)
aicresults <- AIC(beta_full, beta0)

lrtest(beta_full, beta0)

summary(beta_full)


```
#### plot 

```{r plot }

plot_priorweight <- ggplot(start_size_pwr, aes(x=bc, y=power)) +
  geom_point(aes( color= sex, shape=sex),size=4, alpha = 0.8) +
  theme_classic() +
  #geom_label(aes(label=rank)) +
  labs(x="body condition", y= "power score") +
  theme(legend.position = "bottom")
  #geom_smooth(method="lm", se=F, color="black") #+
  #geom_smooth(method="lm" ) # , color="red", fill="#69b3a2", se=TRUE
plot_priorweight


ggsave("figures/FigSM.bcregression.pdf" ,width = 90, height = 60, units = "mm")
```


###2. Is body condition an outcome of rank

bc change between trial capture events
power score change between bin 1 & 5/ bin 5 & 9/ bin 9 & 13 -> however, we do not have power score at rank assessment point 13 due to a tropical storm


We predict that if rank influences body condiion that we would see a positive correlation between weight change and power score change. 
```{r correlation power change and weight change}

#head(power_size)
glimpse(power_size)

change <- power_size %>%
  group_by(id) %>% 
  mutate(lead_cw= lead(bc), 
         cw_change = lead_cw-culmen_width, 
         lead=lead(bc), 
         bc_change = lead-bc, 
         leadp=lead(power), 
         power_change = leadp-power, 
         leadr=lead(rank),
         rank_change=rank-leadr) %>% 
  drop_na() %>%
  dplyr::select(type, id,sex, rank, cw_change, bc_change, power_change, rank_change)
#head(change)
glimpse(change)

change_summ <- change %>%
  group_by(type) %>%
  summarise(mean_dcw=mean(cw_change),
            mean_dbc=mean(bc_change),
            #mean_dweight=mean(weight_change),
            mean_dpower=mean(power_change))


## trial 1 ----
dsize1 <- change %>%
  filter(type=="removal1",id!="BBB" ) #, id!="BBB" -> exclude removed focal bird

ggplot(dsize1, aes(x=bc_change, y=power_change)) +  # filter(dsize1, id!="BBB")
  geom_point() + 
  theme_classic()

# weight change normally distributed
# shapiro test p >0.05, data normally distributed
ggqqplot(dsize1, "bc_change")


m <- lm(power_change ~ bc_change, data = dsize1)
m <- lm(bc_change ~ power_change, data = dsize1)
summary(m)
d <- data.frame(residuals = residuals(m),         # Residuals
                std_residuals = rstudent(m), # Studentized Residuals
                fitted = fitted(m),          # Fitted values
                cooks = cooks.distance(m))   # Cook's D
d <- mutate(d, observation = 1:nrow(d))           # Observation number

# histogram of residuals
ggplot(data = d, aes(x = std_residuals)) +
  geom_histogram(bins = 10)

# Check for Normality: QQ Normality plot of residuals
ggplot(data = d, aes(sample = std_residuals)) +
  stat_qq() +
  stat_qq_line()

# Check heteroscedasticity or constant variance
ggplot(d, aes(x = fitted, y = std_residuals)) +
  geom_point() +
  geom_hline(yintercept = 0)

# Cook's D
ggplot(d, aes(x = observation, y = cooks)) +
  geom_point() +
  geom_hline(yintercept = 1, linetype = "dotted") +
  geom_hline(yintercept = 4/nrow(d), linetype = "dashed")
# outliers
d_outliers <- filter(d, cooks > 4/nrow(d))
#d_outliers # no outliers when log-transformed; 2,31,33,34


# correlation
cor.test(dsize1$power_change, dsize1$bc_change, method="kendall")



## trial 2 ----
dsize2 <- change %>%
  filter(type=="removal2", id!="GPG") #, id!="GPG"

ggplot(dsize2, aes(x=weight_change, y=power_change)) +  # filter(dsize1, id!="BBB")
  geom_point() + 
  theme_classic()


# normally distributed?
ggqqplot(dsize2, "weight_change")
ggqqplot(dsize2, "power_change")


m <- lm(power_change ~ weight_change, data = dsize2)
summary(m)
d <- data.frame(residuals = residuals(m),         # Residuals
                std_residuals = rstudent(m), # Studentized Residuals
                fitted = fitted(m),          # Fitted values
                cooks = cooks.distance(m))   # Cook's D
d <- mutate(d, observation = 1:nrow(d))           # Observation number

# histogram of residuals
ggplot(data = d, aes(x = std_residuals)) +
  geom_histogram(bins = 10)

# Check for Normality: QQ Normality plot of residuals
ggplot(data = d, aes(sample = std_residuals)) +
  stat_qq() +
  stat_qq_line()

# Check heteroscedasticity or constant variance
ggplot(d, aes(x = fitted, y = std_residuals)) +
  geom_point() +
  geom_hline(yintercept = 0)

# Cook's D
ggplot(d, aes(x = observation, y = cooks)) +
  geom_point() +
  geom_hline(yintercept = 1, linetype = "dotted") +
  geom_hline(yintercept = 4/nrow(d), linetype = "dashed")
# outliers
d_outliers <- filter(d, cooks > 4/nrow(d))
#d_outliers # 1 and 17 -> no outliers


# correlation
cor.test(dsize2$power_change, dsize2$bc_change) # pearson: linearity and constant variance -> no
cor.test(dsize2$power_change, dsize2$bc_change, method="kendall")


```
Power and body condition change were not correlated both when the focal was included (trial 1: Kendall's tau = 0.17, p = 0.32; trial 2: kendall's tau = -0.02, p = 0.94) and excluded (trial 1: Kendall's tau = 0.08, p = 0.68; trial 2: kendall's tau = -0.03, p = 0.90)


What percent of birds fall in or outside the 2 quadrants -> would follow our prediction
```{r % follow prediction}

change1 <- change %>%
  filter(type=="removal1") %>%
  mutate(fits_expectation=if_else(bc_change<0&power_change<0, 'yes', 
                                 if_else(bc_change>0&power_change>0, 'yes', 'no'))) %>%
  group_by(fits_expectation) %>%
  tally() %>%
  mutate (percent_expect = n/20*100)

change2 <- change %>%
  filter(type=="removal2") %>%
  mutate(fits_expectation=if_else(bc_change<0&power_change<0, 'yes', 
                                 if_else(bc_change>0&power_change>0, 'yes', 'no'))) %>%
  group_by(fits_expectation) %>%
  tally() %>%
  mutate (percent_expect = n/20*100)

```



##### plot

```{r plot power and weight change}

change$trial <- factor(change$type, 
                           levels = c("removal1",
                                      "removal2"),
                           labels = c("Trial 1","Trial 2"))
change$rank <- as.double(change$rank) 
change <- change %>% ungroup()


library(RColorBrewer)
#display.brewer.all()
#display.brewer.pal(11, "RdYlBu")
pal1 <- RColorBrewer::brewer.pal(11, "RdYlBu")

plot_change <- ggplot(change, aes(x=bc_change, y=power_change)) + 
  geom_point( aes(shape=sex, color=rank), size=4, alpha = 0.8) + 
  facet_wrap(~trial) +
  scale_y_continuous(limits = c(-0.15, 0.15)) +
  scale_x_continuous(limits = c(-8.5, 8.5))+
  theme_classic() +
  theme(legend.position = "bottom")+
  #geom_text(aes(label=rank),  nudge_x=0, nudge_y=0.05) +
  labs(x = "body condition change", y = "power score change") + #, title="Change between capture events"
  geom_hline(yintercept=0,
             linetype="dashed", color="black") + 
  geom_vline(xintercept=0,
             linetype="dashed", color="black") +
  geom_rect(aes(xmin = 0, xmax = Inf, ymin = 0, ymax = Inf),
                   fill = "grey80", alpha = 0.01, color=alpha("grey",0.01)) +
  geom_rect(aes(xmin = -Inf, xmax = 0, ymin = -Inf, ymax = 0),
                   fill = "grey80", alpha = 0.01, color=alpha("grey", 0.01)) +
   scale_color_gradientn(colours = pal1)
  #scale_color_gradient2(midpoint = 10, high = "blue", mid = alpha("yellow",0.2), low = "red")
                  
  #scale_color_gradient(low = "#FF0000",high = "#0000FF") ; #palette = "RdYlBu");  #palette = "Spectral")

plot_change

ggsave("figures/FigSM.bc corr change.pdf",width = 7, height = 3, units = "in")

```



#### focals body condition change
focal birds that were unable to re-take their top rank should also lose weight upon reintroduction: relation between rank loss removal vs weight loss reintroduction. 

in percentage 
body condition gain positive values while  loss negative values

power test 

```{r mass change focals}

focal_weights<- c("capture3","reintroduction1","capture4","reintroduction2","capture5","reintroduction3","capture7")

mass_mean <- size_select %>% 
  dplyr::select(date, type, id, culmen_width, bc) %>%
  separate(perturbation, 
           c("capture", "type"), 
           sep="_", remove = FALSE
             ) %>% 
  dplyr::filter(capture %in% focal_weights, id %in% c("BBB", "GPG", "OPP")) %>%
  group_by(id) %>%
  arrange(id, date) %>%
  mutate(#weighttime2=lead(weight),
         #masschange=weighttime2-weight, 
         mean=mean(bc)) %>% #,massperc = weight/mean*100
  pivot_wider(-c(date,type, capture),
              names_from = type,
              values_from = bc) %>%
  dplyr::select(id,  mean)

# combine mass change in dataframe
focals <- c("BBB", "GPG", "OPP")
size_focals <- size_select %>% 
  dplyr::filter(id %in% c("BBB", "GPG", "OPP")) %>%
  mutate(bc_t2 = lead(bc), 
    bc_change=bc_t2-bc) %>%
  filter(id=="BBB"&type=="removal1"|
         id=="GPG"&type=="removal2"|
         id=="OPP"&type=="removal3")




# plot body condition change with df in long format
focal_long <- size_focals %>%
  dplyr::select(id, removal, reintroduction, trial) %>%
  pivot_longer(-id,
               c("removal", "reintroduction", "trial"),
               names_to = "time",
               values_to = "mass_change")
focal_long$time[focal_long$time==""]<-"removal"

focal_long$period <- factor(focal_long$time, 
                            levels=c("removal", "reintroduction", "trial"))

plot_bc_focals <- size_focals %>%
  #filter(period=="removal") %>%
  ggplot( aes(x=id, y=bc_change, fill=id)) +
  geom_col( colour = "black") +
  #scale_y_continuous(limits = c(-7.5, 5.0)) +
  #facet_wrap(~period) +
  labs(x= "focal bird ID", y= "body condition change", title="") +
  theme_classic() +
  scale_fill_manual(values=alpha(c("#1f78b4","#6a51a3","#ff7f00" ),0.6)) +
  geom_hline(yintercept = 0) +
  theme(legend.position = "none")
#ggsave("figures/figure_focal_mass_change_time.pdf")


```

We found that the focal birds that had an extreme loss of rank (-20 rank positions) upon reintroduction also lost the most body condition.

####group vs focal mass change
Exclude focal birds for only their respective trial 

check percentage mass change of all birds! 
```{r group mass change}
focal_weights<- c("reintroduction1","reintroduction2","reintroduction3")
long_perturb <- c("capture3","capture4","capture5","capture7")

bc_change_all <- size_good %>% 
  dplyr::select(date, perturbation, id, bc) %>%
  separate(perturbation, 
           c("capture", "type"), 
           sep="_", remove = FALSE
             ) %>% 
  dplyr::filter(capture %in% long_perturb) %>%
  group_by(id) %>%
  arrange(id, date) %>% 
  mutate(bctime2=lead(bc),
         bcchange=bctime2-bc, 
         mean=mean(bc),
         perc_change=bcchange/mean*100) %>% # ,massperc = masschange/totalavemass*100
  rename(bctime1=bc)  %>%
  drop_na()



# exclude focal birds
bc_change <- bc_change_all %>%
  filter(!id %in% c("BBB", "GPG", "OPP"))

# exclude focal birds' mass for their trial
  filter(!type =="removal1"| !id=="BBB") %>%
  filter(!type =="removal2"| !id=="GPG") %>%
  filter(!type =="removal3"| !id=="OPP")


totalavemass <- mean(mass_change$weighttime1, na.rm=T)


# summarize excluding focals ----

summ_bc <- bc_change %>%
  filter(!id %in% c("BBB", "GPG", "OPP")) %>%
  group_by(type) %>%
  summarize(mean=mean(bcchange, na.rm = TRUE), 
            sd=sd(bcchange, na.rm = TRUE), 
            n=n(), 
            range=range(bcchange, na.rm = TRUE))



  # plot ----

 set.seed(42)
custom_palette <- c(RColorBrewer::brewer.pal(9, "Set1"),
                    RColorBrewer::brewer.pal(8, "Dark2"),
                    RColorBrewer::brewer.pal(3, "Set2")) %>% 
  sample(n_distinct(bc_change$id))

bc_change$comparison <- factor(bc_change$type,
                                       levels=c("removal1",
                                                "removal2","removal3"),
                                       labels=c("2 vs 1",
                                                "3 vs 2",
                                                "end vs 3"))

plot_dbc <- bc_change %>%
  ggplot( aes(x=comparison, y=bcchange)) + 
  geom_hline(yintercept=0) +
   labs(y="body condition change",
       x="comparison between capture events", 
       title = "between captures") +
  
  # add half-violin from ggdist package 
  ggdist::stat_halfeye(
    adjust = .5, 
    width = .5, 
    .width = 0, 
    justification = -.3, 
    point_colour = NA) + 
  
  # add boxplot
  geom_boxplot(
    width = .25, 
    outlier.shape = NA) +
  
  # add points in jitter position

 ggdist::stat_dots(
    dotsize = 2,
    side="left",
    justification=1.15,
    binwidth=0.15
  ) +
    # other way to add points
# geom_point(
#    size = 2,
#    alpha = .3,
#    position = position_jitter(
#    seed = 1, width = .15 )) + 
  
  # highlight focal birds
  annotate('point', x= .85, y=-5.60706, size = 4, color = "#1f78b4" ) +
  annotate('point', x= 1.85, y=-2.69294, size = 4, color = "#6a51a3") +
  annotate('point', x= 2.85, y=-5.79294, size = 4, color = "#ff7f00" ) +
  
  # adjust theme and color
  theme_classic() + 
  #scale_color_manual(values= "black") + #alpha(c("#1f78b4","#6a51a3","#ff7f00" ))
  #scale_fill_manual(values=alpha(c("#1f78b4","#6a51a3","#ff7f00" ),0.6))+
  theme(legend.position = "none",
        #axis.text.y = element_blank(),
        axis.text = element_text(), #colour = "#2F4858", size = 24
        axis.title.x = element_text() #colour = "#2F4858", size = 24
        ) +
  coord_cartesian(xlim = c(0.8, NA)) 
  #scale_y_continuous(limits = c(-12.0, 5.0)) 
  #scale_fill_tq() +
  #coord_flip() 
  #coord_cartesian(xlim = c(1.2, NA), clip = "off") +
  #geom_text(aes(label = length(playback), y = 10)) +


  plot_dbc
  
ggsave("./figures/SM3_group_bc_change_focalhighlight.pdf")

#       ,width = 90, height = 90, units = "mm")
  
  


```


